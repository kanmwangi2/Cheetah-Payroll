/*! For license information please see 241.c0a4089c7378279f4871.js.LICENSE.txt */
"use strict";(self.webpackChunkcheetah_payroll=self.webpackChunkcheetah_payroll||[]).push([[241],{241:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=n(199),s=n(319),i=n(844),o=n(336),a=n(860),u=n(832);const c="@firebase/firestore";class l{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let h="10.14.0";const d=new i.Logger("@firebase/firestore");function f(){return d.logLevel}function m(e,...t){if(d.logLevel<=i.LogLevel.DEBUG){const n=t.map(y);d.debug(`Firestore (${h}): ${e}`,...n)}}function g(e,...t){if(d.logLevel<=i.LogLevel.ERROR){const n=t.map(y);d.error(`Firestore (${h}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.LogLevel.WARN){const n=t.map(y);d.warn(`Firestore (${h}): ${e}`,...n)}}function y(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function w(e="Unexpected state"){const t=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+e;throw g(t),new Error(t)}function v(e,t){e||w()}function I(e,t){return e}const _={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class b extends o.FirebaseError{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class T{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class E{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class S{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(l.UNAUTHENTICATED))}shutdown(){}}class x{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class C{constructor(e){this.t=e,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){v(void 0===this.o);let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new T;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new T,e.enqueueRetryable(()=>r(this.currentUser))};const i=()=>{const t=s;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),i())};this.t.onInit(e=>o(e)),setTimeout(()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new T)}},0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(v("string"==typeof t.accessToken),new E(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return v(null===e||"string"==typeof e),new l(e)}}class D{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=l.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class N{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new D(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(l.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class A{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class k{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){v(void 0===this.o);const n=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.R;return this.R=e.token,m("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};const r=e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?r(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(v("string"==typeof e.token),this.R=e.token,new A(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}function R(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class F{static newId(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=R(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function M(e,t){return e<t?-1:e>t?1:0}function L(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}function V(e){return e+"\0"}class P{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new b(_.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new b(_.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new b(_.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new b(_.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return P.fromMillis(Date.now())}static fromDate(e){return P.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new P(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?M(this.nanoseconds,e.nanoseconds):M(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class O{constructor(e){this.timestamp=e}static fromTimestamp(e){return new O(e)}static min(){return new O(new P(0,0))}static max(){return new O(new P(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class q{constructor(e,t,n){void 0===t?t=0:t>e.length&&w(),void 0===n?n=e.length-t:n>e.length-t&&w(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===q.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof q?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class U extends q{construct(e,t,n){return new U(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new b(_.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new U(t)}static emptyPath(){return new U([])}}const B=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class z extends q{construct(e,t,n){return new z(e,t,n)}static isValidIdentifier(e){return B.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),z.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new z(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new b(_.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new b(_.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new b(_.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new b(_.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new z(t)}static emptyPath(){return new z([])}}class G{constructor(e){this.path=e}static fromPath(e){return new G(U.fromString(e))}static fromName(e){return new G(U.fromString(e).popFirst(5))}static empty(){return new G(U.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===U.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return U.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new G(new U(e.slice()))}}class K{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function $(e){return e.fields.find(e=>2===e.kind)}function Q(e){return e.fields.filter(e=>2!==e.kind)}function j(e,t){let n=M(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(n=J(e.fields[r],t.fields[r]),0!==n)return n;return M(e.fields.length,t.fields.length)}K.UNKNOWN_ID=-1;class W{constructor(e,t){this.fieldPath=e,this.kind=t}}function J(e,t){const n=z.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:M(e.kind,t.kind)}class H{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new H(0,Z.min())}}function Y(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=O.fromTimestamp(1e9===r?new P(n+1,0):new P(n,r));return new Z(s,G.empty(),t)}function X(e){return new Z(e.readTime,e.key,-1)}class Z{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Z(O.min(),G.empty(),-1)}static max(){return new Z(O.max(),G.empty(),-1)}}function ee(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=G.comparator(e.documentKey,t.documentKey),0!==n?n:M(e.largestBatchId,t.largestBatchId))}const te="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ne{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function re(e){if(e.code!==_.FAILED_PRECONDITION||e.message!==te)throw e;m("LocalStore","Unexpectedly lost primary lease")}class se{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&w(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new se((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{const t=e();return t instanceof se?t:se.resolve(t)}catch(e){return se.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):se.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):se.reject(t)}static resolve(e){return new se((t,n)=>{t(e)})}static reject(e){return new se((t,n)=>{n(e)})}static waitFor(e){return new se((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=se.resolve(!1);for(const n of e)t=t.next(e=>e?se.resolve(e):n());return t}static forEach(e,t){const n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new se((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;t(e[u]).next(e=>{i[u]=e,++o,o===s&&n(i)},e=>r(e))}})}static doWhile(e,t){return new se((n,r)=>{const s=()=>{!0===e()?t().next(()=>{s()},r):n()};s()})}}class ie{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new T,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new ce(e,t.error)):this.V.resolve()},this.transaction.onerror=t=>{const n=me(t.target.error);this.V.reject(new ce(e,n))}}static open(e,t,n,r){try{return new ie(t,e.transaction(r,n))}catch(e){throw new ce(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new he(t)}}class oe{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===oe.S(o.getUA())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),de(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!o.isIndexedDBAvailable())return!1;if(oe.v())return!0;const e=o.getUA(),t=oe.S(e),n=0<t&&t<10,r=ae(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static v(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.C)}static F(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}async M(e){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ce(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new b(_.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new b(_.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ce(e,r))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.p.O(t,r.transaction,e.oldVersion,this.version).next(()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.M(e);const t=ie.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.g(),e)).catch(e=>(t.abort(e),se.reject(e))).toPromise();return i.catch(()=>{}),await t.m,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ae(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class ue{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return de(this.B.delete())}}class ce extends b{constructor(e,t){super(_.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function le(e){return"IndexedDbTransactionError"===e.name}class he{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),de(n)}add(e){return m("SimpleDb","ADD",this.store.name,e,e),de(this.store.add(e))}get(e){return de(this.store.get(e)).next(t=>(void 0===t&&(t=null),m("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),de(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),de(this.store.count())}U(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new se((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{const e=this.cursor(n),t=[];return this.W(e,(e,n)=>{t.push(n)}).next(()=>t)}}G(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new se((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}j(e,t){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;const r=this.cursor(n);return this.W(r,(e,t,n)=>n.delete())}J(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.W(r,t)}Y(e){const t=this.cursor({});return new se((n,r)=>{t.onerror=e=>{const t=me(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}W(e,t){const n=[];return new se((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new ue(s),o=t(s.primaryKey,s.value,i);if(o instanceof se){const e=o.catch(e=>(i.done(),se.reject(e)));n.push(e)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}}).next(()=>se.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function de(e){return new se((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=me(e.target.error);n(t)}})}let fe=!1;function me(e){const t=oe.S(o.getUA());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new b("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return fe||(fe=!0,setTimeout(()=>{throw e},0)),e}}return e}class ge{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){m("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{m("IndexBackfiller",`Documents written: ${await this.Z.ee()}`)}catch(e){le(e)?m("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await re(e)}await this.X(6e4)})}}class pe{constructor(e,t){this.localStore=e,this.persistence=t}async ee(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))}te(e,t){const n=new Set;let r=t,s=!0;return se.doWhile(()=>!0===s&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return m("IndexBackfiller",`Processing collection: ${t}`),this.ne(e,t,r).next(e=>{r-=e,n.add(t)});s=!1})).next(()=>t-r)}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next(()=>this.re(r,n)).next(n=>(m("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>s.size)}))}re(e,t){let n=e;return t.changes.forEach((e,t)=>{const r=X(t);ee(r,n)>0&&(n=r)}),new Z(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ye{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}function we(e){return null==e}function ve(e){return 0===e&&1/e==-1/0}function Ie(e){return"number"==typeof e&&Number.isInteger(e)&&!ve(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function _e(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Te(t)),t=be(e.get(n),t);return Te(t)}function be(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function Te(e){return e+""}function Ee(e){const t=e.length;if(v(t>=2),2===t)return v(""===e.charAt(0)&&""===e.charAt(1)),U.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("",i);switch((t<0||t>n)&&w(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=e.substring(i,t),s+="\0";break;case"":s+=e.substring(i,t+1);break;default:w()}i=t+2}return new U(r)}ye.oe=-1;const Se=["userId","batchId"];function xe(e,t){return[e,_e(t)]}function Ce(e,t,n){return[e,_e(t),n]}const De={},Ne=["prefixPath","collectionGroup","readTime","documentId"],Ae=["prefixPath","collectionGroup","documentId"],ke=["collectionGroup","readTime","prefixPath","documentId"],Re=["canonicalId","targetId"],Fe=["targetId","path"],Me=["path","targetId"],Le=["collectionId","parent"],Ve=["indexId","uid"],Pe=["uid","sequenceNumber"],Oe=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],qe=["indexId","uid","orderedDocumentKey"],Ue=["userId","collectionPath","documentId"],Be=["userId","collectionPath","largestBatchId"],ze=["userId","collectionGroup","largestBatchId"],Ge=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ke=[...Ge,"documentOverlays"],$e=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Qe=$e,je=[...Qe,"indexConfiguration","indexState","indexEntries"],We=je,Je=[...je,"globals"];class He extends ne{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function Ye(e,t){const n=I(e);return oe.F(n._e,t)}function Xe(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Ze(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function et(e,t){const n=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function tt(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class nt{constructor(e,t){this.comparator=e,this.root=t||st.EMPTY}insert(e,t){return new nt(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,st.BLACK,null,null))}remove(e){return new nt(this.comparator,this.root.remove(e,this.comparator).copy(null,null,st.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){const e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new rt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new rt(this.root,e,this.comparator,!1)}getReverseIterator(){return new rt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new rt(this.root,e,this.comparator,!0)}}class rt{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class st{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:st.RED,this.left=null!=r?r:st.EMPTY,this.right=null!=s?s:st.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new st(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return st.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return st.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,st.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,st.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw w();if(this.right.isRed())throw w();const e=this.left.check();if(e!==this.right.check())throw w();return e+(this.isRed()?0:1)}}st.EMPTY=null,st.RED=!0,st.BLACK=!1,st.EMPTY=new class{constructor(){this.size=0}get key(){throw w()}get value(){throw w()}get color(){throw w()}get left(){throw w()}get right(){throw w()}copy(e,t,n,r,s){return this}insert(e,t,n){return new st(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class it{constructor(e){this.comparator=e,this.data=new nt(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ot(this.data.getIterator())}getIteratorFrom(e){return new ot(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof it))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new it(this.comparator);return t.data=e,t}}class ot{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function at(e){return e.hasNext()?e.getNext():void 0}class ut{constructor(e){this.fields=e,e.sort(z.comparator)}static empty(){return new ut([])}unionWith(e){let t=new it(z.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ut(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return L(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ct extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class lt{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ct("Invalid base64 string: "+e):e}}(e);return new lt(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new lt(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return M(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}lt.EMPTY_BYTE_STRING=new lt("");const ht=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function dt(e){if(v(!!e),"string"==typeof e){let t=0;const n=ht.exec(e);if(v(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:ft(e.seconds),nanos:ft(e.nanos)}}function ft(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function mt(e){return"string"==typeof e?lt.fromBase64String(e):lt.fromUint8Array(e)}function gt(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function pt(e){const t=e.mapValue.fields.__previous_value__;return gt(t)?pt(t):t}function yt(e){const t=dt(e.mapValue.fields.__local_write_time__.timestampValue);return new P(t.seconds,t.nanos)}class wt{constructor(e,t,n,r,s,i,o,a,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}class vt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new vt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof vt&&e.projectId===this.projectId&&e.database===this.database}}const It={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},_t={nullValue:"NULL_VALUE"};function bt(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?gt(e)?4:qt(e)?9007199254740991:Pt(e)?10:11:w()}function Tt(e,t){if(e===t)return!0;const n=bt(e);if(n!==bt(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return yt(e).isEqual(yt(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=dt(e.timestampValue),r=dt(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return mt(e.bytesValue).isEqual(mt(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ft(e.geoPointValue.latitude)===ft(t.geoPointValue.latitude)&&ft(e.geoPointValue.longitude)===ft(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ft(e.integerValue)===ft(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ft(e.doubleValue),r=ft(t.doubleValue);return n===r?ve(n)===ve(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return L(e.arrayValue.values||[],t.arrayValue.values||[],Tt);case 10:case 11:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(Xe(n)!==Xe(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!Tt(n[e],r[e])))return!1;return!0}(e,t);default:return w()}}function Et(e,t){return void 0!==(e.values||[]).find(e=>Tt(e,t))}function St(e,t){if(e===t)return 0;const n=bt(e),r=bt(t);if(n!==r)return M(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return M(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ft(e.integerValue||e.doubleValue),r=ft(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return xt(e.timestampValue,t.timestampValue);case 4:return xt(yt(e),yt(t));case 5:return M(e.stringValue,t.stringValue);case 6:return function(e,t){const n=mt(e),r=mt(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=M(n[e],r[e]);if(0!==t)return t}return M(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=M(ft(e.latitude),ft(t.latitude));return 0!==n?n:M(ft(e.longitude),ft(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return Ct(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,s,i;const o=e.fields||{},a=t.fields||{},u=null===(n=o.value)||void 0===n?void 0:n.arrayValue,c=null===(r=a.value)||void 0===r?void 0:r.arrayValue,l=M((null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0,(null===(i=null==c?void 0:c.values)||void 0===i?void 0:i.length)||0);return 0!==l?l:Ct(u,c)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===It.mapValue&&t===It.mapValue)return 0;if(e===It.mapValue)return 1;if(t===It.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let e=0;e<r.length&&e<i.length;++e){const t=M(r[e],i[e]);if(0!==t)return t;const o=St(n[r[e]],s[i[e]]);if(0!==o)return o}return M(r.length,i.length)}(e.mapValue,t.mapValue);default:throw w()}}function xt(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return M(e,t);const n=dt(e),r=dt(t),s=M(n.seconds,r.seconds);return 0!==s?s:M(n.nanos,r.nanos)}function Ct(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=St(n[e],r[e]);if(t)return t}return M(n.length,r.length)}function Dt(e){return Nt(e)}function Nt(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=dt(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return mt(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return G.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Nt(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${Nt(e.fields[s])}`;return n+"}"}(e.mapValue):w()}function At(e){switch(bt(e)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=pt(e);return t?16+At(t):16;case 5:return 2*e.stringValue.length;case 6:return mt(e.bytesValue).approximateByteSize();case 7:return e.referenceValue.length;case 9:return function(e){return(e.values||[]).reduce((e,t)=>e+At(t),0)}(e.arrayValue);case 10:case 11:return function(e){let t=0;return Ze(e.fields,(e,n)=>{t+=e.length+At(n)}),t}(e.mapValue);default:throw w()}}function kt(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Rt(e){return!!e&&"integerValue"in e}function Ft(e){return!!e&&"arrayValue"in e}function Mt(e){return!!e&&"nullValue"in e}function Lt(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Vt(e){return!!e&&"mapValue"in e}function Pt(e){var t,n;return"__vector__"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Ot(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return Ze(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=Ot(n)),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Ot(e.arrayValue.values[n]);return t}return Object.assign({},e)}function qt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}const Ut={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function Bt(e){return"nullValue"in e?_t:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?kt(vt.empty(),G.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?Pt(e)?Ut:{mapValue:{}}:w()}function zt(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?kt(vt.empty(),G.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?Ut:"mapValue"in e?Pt(e)?{mapValue:{}}:It:w()}function Gt(e,t){const n=St(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Kt(e,t){const n=St(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class $t{constructor(e){this.value=e}static empty(){return new $t({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Vt(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Ot(t)}setAll(e){let t=z.emptyPath(),n={},r=[];e.forEach((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=Ot(e):r.push(s.lastSegment())});const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());Vt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Tt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Vt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){Ze(t,(t,n)=>e[t]=n);for(const t of n)delete e[t]}clone(){return new $t(Ot(this.value))}}function Qt(e){const t=[];return Ze(e.fields,(e,n)=>{const r=new z([e]);if(Vt(n)){const e=Qt(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)}),new ut(t)}class jt{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new jt(e,0,O.min(),O.min(),O.min(),$t.empty(),0)}static newFoundDocument(e,t,n,r){return new jt(e,1,t,O.min(),n,r,0)}static newNoDocument(e,t){return new jt(e,2,t,O.min(),O.min(),$t.empty(),0)}static newUnknownDocument(e,t){return new jt(e,3,t,O.min(),O.min(),$t.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(O.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=$t.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=$t.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=O.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof jt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new jt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Wt{constructor(e,t){this.position=e,this.inclusive=t}}function Jt(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?G.comparator(G.fromName(o.referenceValue),n.key):St(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Ht(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Tt(e.position[n],t.position[n]))return!1;return!0}class Yt{constructor(e,t="asc"){this.field=e,this.dir=t}}function Xt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Zt{}class en extends Zt{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new hn(e,t,n):"array-contains"===t?new gn(e,n):"in"===t?new pn(e,n):"not-in"===t?new yn(e,n):"array-contains-any"===t?new wn(e,n):new en(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new dn(e,n):new fn(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(St(t,this.value)):null!==t&&bt(this.value)===bt(t)&&this.matchesComparison(St(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return w()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class tn extends Zt{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new tn(e,t)}matches(e){return nn(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function nn(e){return"and"===e.op}function rn(e){return"or"===e.op}function sn(e){return on(e)&&nn(e)}function on(e){for(const t of e.filters)if(t instanceof tn)return!1;return!0}function an(e){if(e instanceof en)return e.field.canonicalString()+e.op.toString()+Dt(e.value);if(sn(e))return e.filters.map(e=>an(e)).join(",");{const t=e.filters.map(e=>an(e)).join(",");return`${e.op}(${t})`}}function un(e,t){return e instanceof en?function(e,t){return t instanceof en&&e.op===t.op&&e.field.isEqual(t.field)&&Tt(e.value,t.value)}(e,t):e instanceof tn?function(e,t){return t instanceof tn&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce((e,n,r)=>e&&un(n,t.filters[r]),!0)}(e,t):void w()}function cn(e,t){const n=e.filters.concat(t);return tn.create(n,e.op)}function ln(e){return e instanceof en?function(e){return`${e.field.canonicalString()} ${e.op} ${Dt(e.value)}`}(e):e instanceof tn?function(e){return e.op.toString()+" {"+e.getFilters().map(ln).join(" ,")+"}"}(e):"Filter"}class hn extends en{constructor(e,t,n){super(e,t,n),this.key=G.fromName(n.referenceValue)}matches(e){const t=G.comparator(e.key,this.key);return this.matchesComparison(t)}}class dn extends en{constructor(e,t){super(e,"in",t),this.keys=mn(0,t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class fn extends en{constructor(e,t){super(e,"not-in",t),this.keys=mn(0,t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function mn(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>G.fromName(e.referenceValue))}class gn extends en{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Ft(t)&&Et(t.arrayValue,this.value)}}class pn extends en{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Et(this.value.arrayValue,t)}}class yn extends en{constructor(e,t){super(e,"not-in",t)}matches(e){if(Et(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Et(this.value.arrayValue,t)}}class wn extends en{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ft(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Et(this.value.arrayValue,e))}}class vn{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ue=null}}function In(e,t=null,n=[],r=[],s=null,i=null,o=null){return new vn(e,t,n,r,s,i,o)}function _n(e){const t=I(e);if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>an(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),we(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Dt(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Dt(e)).join(",")),t.ue=e}return t.ue}function bn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Xt(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!un(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Ht(e.startAt,t.startAt)&&Ht(e.endAt,t.endAt)}function Tn(e){return G.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function En(e,t){return e.filters.filter(e=>e instanceof en&&e.field.isEqual(t))}function Sn(e,t,n){let r=_t,s=!0;for(const n of En(e,t)){let e=_t,t=!0;switch(n.op){case"<":case"<=":e=Bt(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=_t}Gt({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Gt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function xn(e,t,n){let r=It,s=!0;for(const n of En(e,t)){let e=It,t=!0;switch(n.op){case">=":case">":e=zt(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=It}Kt({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Kt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class Cn{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function Dn(e,t,n,r,s,i,o,a){return new Cn(e,t,n,r,s,i,o,a)}function Nn(e){return new Cn(e)}function An(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function kn(e){return null!==e.collectionGroup}function Rn(e){const t=I(e);if(null===t.ce){t.ce=[];const e=new Set;for(const n of t.explicitOrderBy)t.ce.push(n),e.add(n.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new it(z.comparator);return e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t}(t);r.forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.ce.push(new Yt(r,n))}),e.has(z.keyField().canonicalString())||t.ce.push(new Yt(z.keyField(),n))}return t.ce}function Fn(e){const t=I(e);return t.le||(t.le=Ln(t,Rn(e))),t.le}function Mn(e){const t=I(e);return t.he||(t.he=Ln(t,e.explicitOrderBy)),t.he}function Ln(e,t){if("F"===e.limitType)return In(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{const t="desc"===e.dir?"asc":"desc";return new Yt(e.field,t)});const n=e.endAt?new Wt(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Wt(e.startAt.position,e.startAt.inclusive):null;return In(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function Vn(e,t){const n=e.filters.concat([t]);return new Cn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Pn(e,t,n){return new Cn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function On(e,t){return bn(Fn(e),Fn(t))&&e.limitType===t.limitType}function qn(e){return`${_n(Fn(e))}|lt:${e.limitType}`}function Un(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map(e=>ln(e)).join(", ")}]`),we(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Dt(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Dt(e)).join(",")),`Target(${t})`}(Fn(e))}; limitType=${e.limitType})`}function Bn(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):G.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Rn(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Jt(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Rn(e),t)||e.endAt&&!function(e,t,n){const r=Jt(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Rn(e),t))}(e,t)}function zn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Gn(e){return(t,n)=>{let r=!1;for(const s of Rn(e)){const e=Kn(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function Kn(e,t,n){const r=e.field.isKeyField()?G.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?St(r,s):w()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return w()}}class $n{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){Ze(this.inner,(t,n)=>{for(const[t,r]of n)e(t,r)})}isEmpty(){return tt(this.inner)}size(){return this.innerSize}}const Qn=new nt(G.comparator);function jn(){return Qn}const Wn=new nt(G.comparator);function Jn(...e){let t=Wn;for(const n of e)t=t.insert(n.key,n);return t}function Hn(e){let t=Wn;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function Yn(){return Zn()}function Xn(){return Zn()}function Zn(){return new $n(e=>e.toString(),(e,t)=>e.isEqual(t))}const er=new nt(G.comparator),tr=new it(G.comparator);function nr(...e){let t=tr;for(const n of e)t=t.add(n);return t}const rr=new it(M);function sr(){return rr}function ir(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ve(t)?"-0":t}}function or(e){return{integerValue:""+e}}function ar(e,t){return Ie(t)?or(t):ir(e,t)}class ur{constructor(){this._=void 0}}function cr(e,t,n){return e instanceof dr?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&gt(t)&&(t=pt(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof fr?mr(e,t):e instanceof gr?pr(e,t):function(e,t){const n=hr(e,t),r=wr(n)+wr(e.Pe);return Rt(n)&&Rt(e.Pe)?or(r):ir(e.serializer,r)}(e,t)}function lr(e,t,n){return e instanceof fr?mr(e,t):e instanceof gr?pr(e,t):n}function hr(e,t){return e instanceof yr?function(e){return Rt(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class dr extends ur{}class fr extends ur{constructor(e){super(),this.elements=e}}function mr(e,t){const n=vr(t);for(const t of e.elements)n.some(e=>Tt(e,t))||n.push(t);return{arrayValue:{values:n}}}class gr extends ur{constructor(e){super(),this.elements=e}}function pr(e,t){let n=vr(t);for(const t of e.elements)n=n.filter(e=>!Tt(e,t));return{arrayValue:{values:n}}}class yr extends ur{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function wr(e){return ft(e.integerValue||e.doubleValue)}function vr(e){return Ft(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Ir{constructor(e,t){this.field=e,this.transform=t}}class _r{constructor(e,t){this.version=e,this.transformResults=t}}class br{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new br}static exists(e){return new br(void 0,e)}static updateTime(e){return new br(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Tr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Er{}function Sr(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Lr(e.key,br.none()):new Ar(e.key,e.data,br.none());{const n=e.data,r=$t.empty();let s=new it(z.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new kr(e.key,r,new ut(s.toArray()),br.none())}}function xr(e,t,n){e instanceof Ar?function(e,t,n){const r=e.value.clone(),s=Fr(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof kr?function(e,t,n){if(!Tr(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Fr(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Rr(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Cr(e,t,n,r){return e instanceof Ar?function(e,t,n,r){if(!Tr(e.precondition,t))return n;const s=e.value.clone(),i=Mr(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof kr?function(e,t,n,r){if(!Tr(e.precondition,t))return n;const s=Mr(e.fieldTransforms,r,t),i=t.data;return i.setAll(Rr(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):function(e,t,n){return Tr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Dr(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=hr(r.transform,e||null);null!=s&&(null===n&&(n=$t.empty()),n.set(r.field,s))}return n||null}function Nr(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&L(e,t,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof fr&&t instanceof fr||e instanceof gr&&t instanceof gr?L(e.elements,t.elements,Tt):e instanceof yr&&t instanceof yr?Tt(e.Pe,t.Pe):e instanceof dr&&t instanceof dr}(e.transform,t.transform)}(e,t))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class Ar extends Er{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class kr extends Er{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Rr(e){const t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}}),t}function Fr(e,t,n){const r=new Map;v(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,lr(o,a,n[s]))}return r}function Mr(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,cr(e,i,t))}return r}class Lr extends Er{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Vr extends Er{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Pr{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&xr(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Cr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Cr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Xn();return this.mutations.forEach(r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=Sr(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(O.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),nr())}isEqual(e){return this.batchId===e.batchId&&L(this.mutations,e.mutations,(e,t)=>Nr(e,t))&&L(this.baseMutations,e.baseMutations,(e,t)=>Nr(e,t))}}class Or{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){v(e.mutations.length===n.length);let r=er;const s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new Or(e,t,n,r)}}class qr{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Ur{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class Br{constructor(e,t){this.count=e,this.unchangedNames=t}}var zr,Gr;function Kr(e){switch(e){default:return w();case _.CANCELLED:case _.UNKNOWN:case _.DEADLINE_EXCEEDED:case _.RESOURCE_EXHAUSTED:case _.INTERNAL:case _.UNAVAILABLE:case _.UNAUTHENTICATED:return!1;case _.INVALID_ARGUMENT:case _.NOT_FOUND:case _.ALREADY_EXISTS:case _.PERMISSION_DENIED:case _.FAILED_PRECONDITION:case _.ABORTED:case _.OUT_OF_RANGE:case _.UNIMPLEMENTED:case _.DATA_LOSS:return!0}}function $r(e){if(void 0===e)return g("GRPC error has no .code"),_.UNKNOWN;switch(e){case zr.OK:return _.OK;case zr.CANCELLED:return _.CANCELLED;case zr.UNKNOWN:return _.UNKNOWN;case zr.DEADLINE_EXCEEDED:return _.DEADLINE_EXCEEDED;case zr.RESOURCE_EXHAUSTED:return _.RESOURCE_EXHAUSTED;case zr.INTERNAL:return _.INTERNAL;case zr.UNAVAILABLE:return _.UNAVAILABLE;case zr.UNAUTHENTICATED:return _.UNAUTHENTICATED;case zr.INVALID_ARGUMENT:return _.INVALID_ARGUMENT;case zr.NOT_FOUND:return _.NOT_FOUND;case zr.ALREADY_EXISTS:return _.ALREADY_EXISTS;case zr.PERMISSION_DENIED:return _.PERMISSION_DENIED;case zr.FAILED_PRECONDITION:return _.FAILED_PRECONDITION;case zr.ABORTED:return _.ABORTED;case zr.OUT_OF_RANGE:return _.OUT_OF_RANGE;case zr.UNIMPLEMENTED:return _.UNIMPLEMENTED;case zr.DATA_LOSS:return _.DATA_LOSS;default:return w()}}(Gr=zr||(zr={}))[Gr.OK=0]="OK",Gr[Gr.CANCELLED=1]="CANCELLED",Gr[Gr.UNKNOWN=2]="UNKNOWN",Gr[Gr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Gr[Gr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Gr[Gr.NOT_FOUND=5]="NOT_FOUND",Gr[Gr.ALREADY_EXISTS=6]="ALREADY_EXISTS",Gr[Gr.PERMISSION_DENIED=7]="PERMISSION_DENIED",Gr[Gr.UNAUTHENTICATED=16]="UNAUTHENTICATED",Gr[Gr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Gr[Gr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Gr[Gr.ABORTED=10]="ABORTED",Gr[Gr.OUT_OF_RANGE=11]="OUT_OF_RANGE",Gr[Gr.UNIMPLEMENTED=12]="UNIMPLEMENTED",Gr[Gr.INTERNAL=13]="INTERNAL",Gr[Gr.UNAVAILABLE=14]="UNAVAILABLE",Gr[Gr.DATA_LOSS=15]="DATA_LOSS";let Qr=null;function jr(){return new TextEncoder}const Wr=new a.Integer([4294967295,4294967295],0);function Jr(e){const t=jr().encode(e),n=new a.Md5;return n.update(t),new Uint8Array(n.digest())}function Hr(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.Integer([n,r],0),new a.Integer([s,i],0)]}class Yr{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Xr(`Invalid padding: ${t}`);if(n<0)throw new Xr(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Xr(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Xr(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=a.Integer.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(a.Integer.fromNumber(n)));return 1===r.compare(Wr)&&(r=new a.Integer([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=Jr(e),[n,r]=Hr(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);if(!this.de(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new Yr(s,r,t);return n.forEach(e=>i.insert(e)),i}insert(e){if(0===this.Ie)return;const t=Jr(e),[n,r]=Hr(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);this.Ae(t)}}Ae(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Xr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Zr{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,es.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Zr(O.min(),r,new nt(M),jn(),nr())}}class es{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new es(n,t,nr(),nr(),nr())}}class ts{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class ns{constructor(e,t){this.targetId=e,this.me=t}}class rs{constructor(e,t,n=lt.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class ss{constructor(){this.fe=0,this.ge=as(),this.pe=lt.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=nr(),t=nr(),n=nr();return this.ge.forEach((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:w()}}),new es(this.pe,this.ye,e,t,n)}Ce(){this.we=!1,this.ge=as()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,v(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class is{constructor(e){this.Le=e,this.Be=new Map,this.ke=jn(),this.qe=os(),this.Qe=new nt(M)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:w()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((e,n)=>{this.ze(n)&&t(n)})}He(e){const t=e.targetId,n=e.me.count,r=this.Je(t);if(r){const s=r.target;if(Tn(s))if(0===n){const e=new G(s.path);this.Ue(t,e,jt.newNoDocument(e,O.min()))}else v(1===n);else{const r=this.Ye(t);if(r!==n){const n=this.Ze(e),s=n?this.Xe(n,e,r):1;if(0!==s){this.je(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}null==Qr||Qr.et(function(e,t,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:e=>{var t;return null!==(t=null==r?void 0:r.mightContain(e))&&void 0!==t&&t}}),h}(r,e.me,this.Le.tt(),n,s))}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=t;let i,o;try{i=mt(n).toUint8Array()}catch(e){if(e instanceof ct)return p("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{o=new Yr(i,r,s)}catch(e){return p(e instanceof Xr?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===o.Ie?null:o}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let r=0;return n.forEach(n=>{const s=this.Le.tt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.Ue(t,n,null),r++)}),r}rt(e){const t=new Map;this.Be.forEach((n,r)=>{const s=this.Je(r);if(s){if(n.current&&Tn(s.target)){const t=new G(s.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,jt.newNoDocument(t,e))}n.be&&(t.set(r,n.ve()),n.Ce())}});let n=nr();this.qe.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{const t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.ke.forEach((t,n)=>n.setReadTime(e));const r=new Zr(e,t,this.Qe,this.ke,n);return this.ke=jn(),this.qe=os(),this.Qe=new nt(M),r}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new ss,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new it(M),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new ss),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function os(){return new nt(G.comparator)}function as(){return new nt(G.comparator)}const us={asc:"ASCENDING",desc:"DESCENDING"},cs={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ls={and:"AND",or:"OR"};class hs{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ds(e,t){return e.useProto3Json||we(t)?t:{value:t}}function fs(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function ms(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function gs(e,t){return fs(e,t.toTimestamp())}function ps(e){return v(!!e),O.fromTimestamp(function(e){const t=dt(e);return new P(t.seconds,t.nanos)}(e))}function ys(e,t){return ws(e,t).canonicalString()}function ws(e,t){const n=function(e){return new U(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function vs(e){const t=U.fromString(e);return v(zs(t)),t}function Is(e,t){return ys(e.databaseId,t.path)}function _s(e,t){const n=vs(t);if(n.get(1)!==e.databaseId.projectId)throw new b(_.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new b(_.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new G(Ss(n))}function bs(e,t){return ys(e.databaseId,t)}function Ts(e){const t=vs(e);return 4===t.length?U.emptyPath():Ss(t)}function Es(e){return new U(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ss(e){return v(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function xs(e,t,n){return{name:Is(e,t),fields:n.value.mapValue.fields}}function Cs(e,t,n){const r=_s(e,t.name),s=ps(t.updateTime),i=t.createTime?ps(t.createTime):O.min(),o=new $t({mapValue:{fields:t.fields}}),a=jt.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Ds(e,t){let n;if(t instanceof Ar)n={update:xs(e,t.key,t.value)};else if(t instanceof Lr)n={delete:Is(e,t.key)};else if(t instanceof kr)n={update:xs(e,t.key,t.data),updateMask:Bs(t.fieldMask)};else{if(!(t instanceof Vr))return w();n={verify:Is(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e,t){const n=t.transform;if(n instanceof dr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof fr)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof gr)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof yr)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw w()}(0,e))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:gs(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:w()}(e,t.precondition)),n}function Ns(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?br.updateTime(ps(e.updateTime)):void 0!==e.exists?br.exists(e.exists):br.none()}(t.currentDocument):br.none(),r=t.updateTransforms?t.updateTransforms.map(t=>function(e,t){let n=null;if("setToServerValue"in t)v("REQUEST_TIME"===t.setToServerValue),n=new dr;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new fr(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new gr(e)}else"increment"in t?n=new yr(e,t.increment):w();const r=z.fromServerFormat(t.fieldPath);return new Ir(r,n)}(e,t)):[];if(t.update){t.update.name;const s=_s(e,t.update.name),i=new $t({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new ut(t.map(e=>z.fromServerFormat(e)))}(t.updateMask);return new kr(s,i,e,n,r)}return new Ar(s,i,n,r)}if(t.delete){const r=_s(e,t.delete);return new Lr(r,n)}if(t.verify){const r=_s(e,t.verify);return new Vr(r,n)}return w()}function As(e,t){return{documents:[bs(e,t.path)]}}function ks(e,t){const n={structuredQuery:{}},r=t.path;let s;null!==t.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=bs(e,s);const i=function(e){if(0!==e.length)return Us(tn.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const o=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:Os(e.field),direction:Ls(e.dir)}}(e))}(t.orderBy);o&&(n.structuredQuery.orderBy=o);const a=ds(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{_t:n,parent:s}}function Rs(e,t,n,r){const{_t:s,parent:i}=ks(e,t),o={},a=[];let u=0;return n.forEach(e=>{const t=r?e.alias:"aggregate_"+u++;o[t]=e.alias,"count"===e.aggregateType?a.push({alias:t,count:{}}):"avg"===e.aggregateType?a.push({alias:t,avg:{field:Os(e.fieldPath)}}):"sum"===e.aggregateType&&a.push({alias:t,sum:{field:Os(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:a,structuredQuery:s.structuredQuery},parent:s.parent},ut:o,parent:i}}function Fs(e){let t=Ts(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){v(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=Ms(e);return t instanceof tn&&sn(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=function(e){return e.map(e=>function(e){return new Yt(qs(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))}(n.orderBy));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,we(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new Wt(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new Wt(n,t)}(n.endAt)),Dn(t,s,o,i,a,"F",u,c)}function Ms(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=qs(e.unaryFilter.field);return en.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=qs(e.unaryFilter.field);return en.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=qs(e.unaryFilter.field);return en.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=qs(e.unaryFilter.field);return en.create(s,"!=",{nullValue:"NULL_VALUE"});default:return w()}}(e):void 0!==e.fieldFilter?function(e){return en.create(qs(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return w()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return tn.create(e.compositeFilter.filters.map(e=>Ms(e)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return w()}}(e.compositeFilter.op))}(e):w()}function Ls(e){return us[e]}function Vs(e){return cs[e]}function Ps(e){return ls[e]}function Os(e){return{fieldPath:e.canonicalString()}}function qs(e){return z.fromServerFormat(e.fieldPath)}function Us(e){return e instanceof en?function(e){if("=="===e.op){if(Lt(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NAN"}};if(Mt(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Lt(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NOT_NAN"}};if(Mt(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Os(e.field),op:Vs(e.op),value:e.value}}}(e):e instanceof tn?function(e){const t=e.getFilters().map(e=>Us(e));return 1===t.length?t[0]:{compositeFilter:{op:Ps(e.op),filters:t}}}(e):w()}function Bs(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function zs(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Gs{constructor(e,t,n,r,s=O.min(),i=O.min(),o=lt.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new Gs(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Gs(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Gs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Gs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Ks{constructor(e){this.ct=e}}function $s(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Qs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:Is(e,t.key),fields:t.data.value.mapValue.fields,updateTime:fs(e,t.version.toTimestamp()),createTime:fs(e,t.createTime.toTimestamp())}}(e.ct,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:js(t.version)};else{if(!t.isUnknownDocument())return w();r.unknownDocument={path:n.path.toArray(),version:js(t.version)}}return r}function Qs(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function js(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Ws(e){const t=new P(e.seconds,e.nanoseconds);return O.fromTimestamp(t)}function Js(e,t){const n=(t.baseMutations||[]).map(t=>Ns(e.ct,t));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map(t=>Ns(e.ct,t)),s=P.fromMillis(t.localWriteTimeMs);return new Pr(t.batchId,s,n,r)}function Hs(e){const t=Ws(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Ws(e.lastLimboFreeSnapshotVersion):O.min();let r;return r=function(e){return void 0!==e.documents}(e.query)?function(e){return v(1===e.documents.length),Fn(Nn(Ts(e.documents[0])))}(e.query):function(e){return Fn(Fs(e))}(e.query),new Gs(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,lt.fromBase64String(e.resumeToken))}function Ys(e,t){const n=js(t.snapshotVersion),r=js(t.lastLimboFreeSnapshotVersion);let s;s=Tn(t.target)?As(e.ct,t.target):ks(e.ct,t.target)._t;const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:_n(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Xs(e){const t=Fs({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Pn(t,t.limit,"L"):t}function Zs(e,t){return new qr(t.largestBatchId,Ns(e.ct,t.overlayMutation))}function ei(e,t){const n=t.path.lastSegment();return[e,_e(t.path.popLast()),n]}function ti(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:js(r.readTime),documentKey:_e(r.documentKey.path),largestBatchId:r.largestBatchId}}class ni{getBundleMetadata(e,t){return ri(e).get(t).next(e=>{if(e)return function(e){return{id:e.bundleId,createTime:Ws(e.createTime),version:e.version}}(e)})}saveBundleMetadata(e,t){return ri(e).put(function(e){return{bundleId:e.id,createTime:js(ps(e.createTime)),version:e.version}}(t))}getNamedQuery(e,t){return si(e).get(t).next(e=>{if(e)return function(e){return{name:e.name,query:Xs(e.bundledQuery),readTime:Ws(e.readTime)}}(e)})}saveNamedQuery(e,t){return si(e).put(function(e){return{name:e.name,readTime:js(ps(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function ri(e){return Ye(e,"bundles")}function si(e){return Ye(e,"namedQueries")}class ii{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){const n=t.uid||"";return new ii(e,n)}getOverlay(e,t){return oi(e).get(ei(this.userId,t)).next(e=>e?Zs(this.serializer,e):null)}getOverlays(e,t){const n=Yn();return se.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){const r=[];return n.forEach((n,s)=>{const i=new qr(t,s);r.push(this.ht(e,i))}),se.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach(e=>r.add(_e(e.getCollectionPath())));const s=[];return r.forEach(t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(oi(e).j("collectionPathOverlayIndex",r))}),se.waitFor(s)}getOverlaysForCollection(e,t,n){const r=Yn(),s=_e(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return oi(e).U("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=Zs(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){const s=Yn();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return oi(e).J({index:"collectionGroupOverlayIndex",range:o},(e,t,n)=>{const o=Zs(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()}).next(()=>s)}ht(e,t){return oi(e).put(function(e,t,n){const[r,s,i]=ei(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ds(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function oi(e){return Ye(e,"documentOverlays")}class ai{Pt(e){return Ye(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(e=>{const t=null==e?void 0:e.value;return t?lt.fromUint8Array(t):lt.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class ui{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(ft(e.integerValue));else if("doubleValue"in e){const n=ft(e.doubleValue);isNaN(n)?this.dt(t,13):(this.dt(t,15),ve(n)?t.At(0):t.At(n))}else if("timestampValue"in e){let n=e.timestampValue;this.dt(t,20),"string"==typeof n&&(n=dt(n)),t.Rt(`${n.seconds||""}`),t.At(n.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(mt(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.dt(t,45),t.At(n.latitude||0),t.At(n.longitude||0)}else"mapValue"in e?qt(e)?this.dt(t,Number.MAX_SAFE_INTEGER):Pt(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):w()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){const n=e.fields||{};this.dt(t,55);for(const e of Object.keys(n))this.Vt(e,t),this.Tt(n[e],t)}wt(e,t){var n,r;const s=e.fields||{};this.dt(t,53);const i="value",o=(null===(r=null===(n=s[i].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.length)||0;this.dt(t,15),t.At(ft(o)),this.Vt(i,t),this.Tt(s[i],t)}bt(e,t){const n=e.values||[];this.dt(t,50);for(const e of n)this.Tt(e,t)}yt(e,t){this.dt(t,37),G.fromName(e).path.forEach(e=>{this.dt(t,60),this.Dt(e,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}}function ci(e){if(0===e)return 8;let t=0;return!(e>>4)&&(t+=4,e<<=4),!(e>>6)&&(t+=2,e<<=2),!(e>>7)&&(t+=1),t}function li(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=ci(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}ui.vt=new ui;class hi{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Lt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{const e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Bt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ot(e);else if(e<2048)this.Ot(960|e>>>6),this.Ot(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e);else{const e=t.codePointAt(0);this.Ot(240|e>>>18),this.Ot(128|63&e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e)}}this.Nt()}kt(e){const t=this.qt(e),n=li(t);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Kt(e){const t=this.qt(e),n=li(t);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Ft(e){const t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){const t=255&e;0===t?(this.Gt(0),this.Gt(255)):255===t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class di{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}}class fi{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class mi{constructor(){this.jt=new hi,this.Ht=new di(this.jt),this.Jt=new fi(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class gi{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Zt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new gi(this.indexId,this.documentKey,this.arrayValue,n)}}function pi(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=yi(e.arrayValue,t.arrayValue),0!==n?n:(n=yi(e.directionalValue,t.directionalValue),0!==n?n:G.comparator(e.documentKey,t.documentKey)))}function yi(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class wi{constructor(e){this.Xt=new it((e,t)=>z.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[];for(const t of e.filters){const e=t;e.isInequality()?this.Xt=this.Xt.add(e):this.tn.push(e)}}get nn(){return this.Xt.size>1}rn(e){if(v(e.collectionGroup===this.collectionId),this.nn)return!1;const t=$(e);if(void 0!==t&&!this.sn(t))return!1;const n=Q(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.sn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Xt.size>0){const e=this.Xt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.on(e,t)||!this._n(this.en[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.en.length||!this._n(this.en[i++],e))return!1}return!0}an(){if(this.nn)return null;let e=new it(z.comparator);const t=[];for(const n of this.tn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new W(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new W(n.field,0))}for(const n of this.en)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new W(n.field,"asc"===n.dir?0:1)));return new K(K.UNKNOWN_ID,this.collectionId,t,H.empty())}sn(e){for(const t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function vi(e){var t,n;if(v(e instanceof en||e instanceof tn),e instanceof en){if(e instanceof pn){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map(t=>en.create(e.field,"==",t)))||[];return tn.create(r,"or")}return e}const r=e.filters.map(e=>vi(e));return tn.create(r,e.op)}function Ii(e){if(0===e.getFilters().length)return[];const t=Ei(vi(e));return v(Ti(t)),_i(t)||bi(t)?[t]:t.getFilters()}function _i(e){return e instanceof en}function bi(e){return e instanceof tn&&sn(e)}function Ti(e){return _i(e)||bi(e)||function(e){if(e instanceof tn&&rn(e)){for(const t of e.getFilters())if(!_i(t)&&!bi(t))return!1;return!0}return!1}(e)}function Ei(e){if(v(e instanceof en||e instanceof tn),e instanceof en)return e;if(1===e.filters.length)return Ei(e.filters[0]);const t=e.filters.map(e=>Ei(e));let n=tn.create(t,e.op);return n=Ci(n),Ti(n)?n:(v(n instanceof tn),v(nn(n)),v(n.filters.length>1),n.filters.reduce((e,t)=>Si(e,t)))}function Si(e,t){let n;return v(e instanceof en||e instanceof tn),v(t instanceof en||t instanceof tn),n=e instanceof en?t instanceof en?function(e,t){return tn.create([e,t],"and")}(e,t):xi(e,t):t instanceof en?xi(t,e):function(e,t){if(v(e.filters.length>0&&t.filters.length>0),nn(e)&&nn(t))return cn(e,t.getFilters());const n=rn(e)?e:t,r=rn(e)?t:e,s=n.filters.map(e=>Si(e,r));return tn.create(s,"or")}(e,t),Ci(n)}function xi(e,t){if(nn(t))return cn(t,e.getFilters());{const n=t.filters.map(t=>Si(e,t));return tn.create(n,"or")}}function Ci(e){if(v(e instanceof en||e instanceof tn),e instanceof en)return e;const t=e.getFilters();if(1===t.length)return Ci(t[0]);if(on(e))return e;const n=t.map(e=>Ci(e)),r=[];return n.forEach(t=>{t instanceof en?r.push(t):t instanceof tn&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:tn.create(r,e.op)}class Di{constructor(){this.un=new Ni}addToCollectionParentIndex(e,t){return this.un.add(t),se.resolve()}getCollectionParents(e,t){return se.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return se.resolve()}deleteFieldIndex(e,t){return se.resolve()}deleteAllFieldIndexes(e){return se.resolve()}createTargetIndexes(e,t){return se.resolve()}getDocumentsMatchingTarget(e,t){return se.resolve(null)}getIndexType(e,t){return se.resolve(0)}getFieldIndexes(e,t){return se.resolve([])}getNextCollectionGroupToUpdate(e){return se.resolve(null)}getMinOffset(e,t){return se.resolve(Z.min())}getMinOffsetFromCollectionGroup(e,t){return se.resolve(Z.min())}updateCollectionGroup(e,t,n){return se.resolve()}updateIndexEntries(e,t){return se.resolve()}}class Ni{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new it(U.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new it(U.comparator)).toArray()}}const Ai=new Uint8Array(0);class ki{constructor(e,t){this.databaseId=t,this.cn=new Ni,this.ln=new $n(e=>_n(e),(e,t)=>bn(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});const s={collectionId:n,parent:_e(r)};return Ri(e).put(s)}return se.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[V(t),""],!1,!0);return Ri(e).U(r).next(e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Ee(r.parent))}return n})}addFieldIndex(e,t){const n=Mi(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=Li(e);return s.next(e=>{n.put(ti(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=Mi(e),r=Li(e),s=Fi(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=Mi(e),n=Fi(e),r=Li(e);return t.j().next(()=>n.j()).next(()=>r.j())}createTargetIndexes(e,t){return se.forEach(this.hn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){const n=new wi(t).an();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){const n=Fi(e);let r=!0;const s=new Map;return se.forEach(this.hn(t),t=>this.Pn(e,t).next(e=>{r&&(r=!!e),s.set(t,e)})).next(()=>{if(r){let e=nr();const r=[];return se.forEach(s,(s,i)=>{m("IndexedDbIndexManager",`Using index ${function(e){return`id=${e.indexId}|cg=${e.collectionGroup}|f=${e.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`}(s)} to execute ${_n(t)}`);const o=function(e,t){const n=$(t);if(void 0===n)return null;for(const t of En(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(i,s),a=function(e,t){const n=new Map;for(const r of Q(t))for(const t of En(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),u=function(e,t){const n=[];let r=!0;for(const s of Q(t)){const t=0===s.kind?Sn(e,s.fieldPath,e.startAt):xn(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Wt(n,r)}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of Q(t)){const t=0===s.kind?xn(e,s.fieldPath,e.endAt):Sn(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Wt(n,r)}(i,s),l=this.In(s,i,u),h=this.In(s,i,c),d=this.Tn(s,i,a),f=this.En(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return se.forEach(f,s=>n.G(s,t.limit).next(t=>{t.forEach(t=>{const n=G.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return se.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(t=0===e.filters.length?[e]:Ii(tn.create(e.filters,"and")).map(t=>In(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t),t)}En(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.dn(t[l/u]):Ai,h=this.An(e,a,n[l%u],r),d=this.Rn(e,a,s[l%u],i),f=o.map(t=>this.An(e,a,t,!0));c.push(...this.createRange(h,d,f))}return c}An(e,t,n,r){const s=new gi(e,G.empty(),t,n);return r?s:s.Zt()}Rn(e,t,n,r){const s=new gi(e,G.empty(),t,n);return r?s.Zt():s}Pn(e,t){const n=new wi(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(const r of e)n.rn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2;const r=this.hn(t);return se.forEach(r,t=>this.Pn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new it(z.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n)}Vn(e,t){const n=new mi;for(const r of Q(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Yt(r.kind);ui.vt.It(e,s)}return n.zt()}dn(e){const t=new mi;return ui.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){const n=new mi;return ui.vt.It(kt(this.databaseId,t),n.Yt(function(e){const t=Q(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.zt()}Tn(e,t,n){if(null===n)return[];let r=[];r.push(new mi);let s=0;for(const i of Q(e)){const e=n[s++];for(const n of r)if(this.fn(t,i.fieldPath)&&Ft(e))r=this.gn(r,i,e);else{const t=n.Yt(i.kind);ui.vt.It(e,t)}}return this.pn(r)}In(e,t,n){return this.Tn(e,t,n.position)}pn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].zt();return t}gn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new mi;r.seed(n.zt()),ui.vt.It(e,r.Yt(t.kind)),s.push(r)}return s}fn(e,t){return!!e.filters.find(e=>e instanceof en&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=Mi(e),r=Li(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next(e=>{const t=[];return se.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){const n=t?new H(t.sequenceNumber,new Z(Ws(t.readTime),new G(Ee(t.documentKey)),t.largestBatchId)):H.empty(),r=e.fields.map(([e,t])=>new W(z.fromServerFormat(e),t));return new K(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:M(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){const r=Mi(e),s=Li(e);return this.yn(e).next(e=>r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(t=>se.forEach(t,t=>s.put(ti(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){const n=new Map;return se.forEach(t,(t,r)=>{const s=n.get(t.collectionGroup);return(s?se.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next(s=>(n.set(t.collectionGroup,s),se.forEach(s,n=>this.wn(e,t,n).next(t=>{const s=this.Sn(r,n);return t.isEqual(s)?se.resolve():this.bn(e,r,n,t,s)}))))})}Dn(e,t,n,r){return Fi(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.mn(n,t.key),documentKey:t.key.path.toArray()})}vn(e,t,n,r){return Fi(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.mn(n,t.key),t.key.path.toArray()])}wn(e,t,n){const r=Fi(e);let s=new it(pi);return r.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,t)])},(e,r)=>{s=s.add(new gi(n.indexId,t,r.arrayValue,r.directionalValue))}).next(()=>s)}Sn(e,t){let n=new it(pi);const r=this.Vn(t,e);if(null==r)return n;const s=$(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Ft(i))for(const s of i.arrayValue.values||[])n=n.add(new gi(t.indexId,e.key,this.dn(s),r))}else n=n.add(new gi(t.indexId,e.key,Ai,r));return n}bn(e,t,n,r,s){m("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=at(i),u=at(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=at(o)):t?(s(a),a=at(i)):(a=at(i),u=at(o))}}(r,s,pi,r=>{i.push(this.Dn(e,t,n,r))},r=>{i.push(this.vn(e,t,n,r))}),se.waitFor(i)}yn(e){let t=1;return Li(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>pi(e,t)).filter((e,t,n)=>!t||0!==pi(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=pi(s,e),i=pi(s,t);if(0===n)r[0]=e.Zt();else if(n>0&&i<0)r.push(s),r.push(s.Zt());else if(i>0)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.Cn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,Ai,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,Ai,[]];s.push(IDBKeyRange.bound(t,n))}return s}Cn(e,t){return pi(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Vi)}getMinOffset(e,t){return se.mapArray(this.hn(t),t=>this.Pn(e,t).next(e=>e||w())).next(Vi)}}function Ri(e){return Ye(e,"collectionParents")}function Fi(e){return Ye(e,"indexEntries")}function Mi(e){return Ye(e,"indexConfiguration")}function Li(e){return Ye(e,"indexState")}function Vi(e){v(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;ee(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new Z(t.readTime,t.documentKey,n)}const Pi={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Oi{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Oi(e,Oi.DEFAULT_COLLECTION_PERCENTILE,Oi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function qi(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.J({range:o},(e,t,n)=>(a++,n.delete()));i.push(u.next(()=>{v(1===a)}));const c=[];for(const e of n.mutations){const r=Ce(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return se.waitFor(i).next(()=>c)}function Ui(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw w();t=e.noDocument}return JSON.stringify(t).length}Oi.DEFAULT_COLLECTION_PERCENTILE=10,Oi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Oi.DEFAULT=new Oi(41943040,Oi.DEFAULT_COLLECTION_PERCENTILE,Oi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Oi.DISABLED=new Oi(-1,0,0);class Bi{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Fn={}}static lt(e,t,n,r){v(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Bi(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Gi(e).J({index:"userMutationsIndex",range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){const s=Ki(e),i=Gi(e);return i.add({}).next(o=>{v("number"==typeof o);const a=new Pr(o,t,n,r),u=function(e,t,n){const r=n.baseMutations.map(t=>Ds(e.ct,t)),s=n.mutations.map(t=>Ds(e.ct,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new it((e,t)=>M(e.canonicalString(),t.canonicalString()));for(const e of r){const t=Ce(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,De))}return l.forEach(t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Fn[o]=a.keys()}),se.waitFor(c).next(()=>a)})}lookupMutationBatch(e,t){return Gi(e).get(t).next(e=>e?(v(e.userId===this.userId),Js(this.serializer,e)):null)}Mn(e,t){return this.Fn[t]?se.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){const n=e.keys();return this.Fn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Gi(e).J({index:"userMutationsIndex",range:r},(e,t,r)=>{t.userId===this.userId&&(v(t.batchId>=n),s=Js(this.serializer,t)),r.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Gi(e).J({index:"userMutationsIndex",range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Gi(e).U("userMutationsIndex",t).next(e=>e.map(e=>Js(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=xe(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return Ki(e).J({range:r},(n,r,i)=>{const[o,a,u]=n,c=Ee(a);if(o===this.userId&&t.path.isEqual(c))return Gi(e).get(u).next(e=>{if(!e)throw w();v(e.userId===this.userId),s.push(Js(this.serializer,e))});i.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new it(M);const r=[];return t.forEach(t=>{const s=xe(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=Ki(e).J({range:i},(e,r,s)=>{const[i,o,a]=e,u=Ee(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()});r.push(o)}),se.waitFor(r).next(()=>this.xn(e,n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=xe(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new it(M);return Ki(e).J({range:i},(e,t,s)=>{const[i,a,u]=e,c=Ee(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()}).next(()=>this.xn(e,o))}xn(e,t){const n=[],r=[];return t.forEach(t=>{r.push(Gi(e).get(t).next(e=>{if(null===e)throw w();v(e.userId===this.userId),n.push(Js(this.serializer,e))}))}),se.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return qi(e._e,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),se.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return se.resolve();const n=IDBKeyRange.lowerBound(function(e){return[e]}(this.userId)),r=[];return Ki(e).J({range:n},(e,t,n)=>{if(e[0]===this.userId){const t=Ee(e[1]);r.push(t)}else n.done()}).next(()=>{v(0===r.length)})})}containsKey(e,t){return zi(e,this.userId,t)}Nn(e){return $i(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function zi(e,t,n){const r=xe(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Ki(e).J({range:i,H:!0},(e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()}).next(()=>o)}function Gi(e){return Ye(e,"mutations")}function Ki(e){return Ye(e,"documentMutations")}function $i(e){return Ye(e,"mutationQueues")}class Qi{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new Qi(0)}static kn(){return new Qi(-1)}}class ji{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{const n=new Qi(t.highestTargetId);return t.highestTargetId=n.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(e=>O.fromTimestamp(new P(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.qn(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Qn(e,r)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(n=>(n.targetCount+=1,this.$n(t,n),this.Qn(e,n))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Wi(e).delete(t.targetId)).next(()=>this.qn(e)).next(t=>(v(t.targetCount>0),t.targetCount-=1,this.Qn(e,t)))}removeTargets(e,t,n){let r=0;const s=[];return Wi(e).J((i,o)=>{const a=Hs(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))}).next(()=>se.waitFor(s)).next(()=>r)}forEachTarget(e,t){return Wi(e).J((e,n)=>{const r=Hs(n);t(r)})}qn(e){return Ji(e).get("targetGlobalKey").next(e=>(v(null!==e),e))}Qn(e,t){return Ji(e).put("targetGlobalKey",t)}Kn(e,t){return Wi(e).put(Ys(this.serializer,t))}$n(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.qn(e).next(e=>e.targetCount)}getTargetData(e,t){const n=_n(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Wi(e).J({range:r,index:"queryTargetsIndex"},(e,n,r)=>{const i=Hs(n);bn(t,i.target)&&(s=i,r.done())}).next(()=>s)}addMatchingKeys(e,t,n){const r=[],s=Hi(e);return t.forEach(t=>{const i=_e(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))}),se.waitFor(r)}removeMatchingKeys(e,t,n){const r=Hi(e);return se.forEach(t,t=>{const s=_e(t.path);return se.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){const n=Hi(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Hi(e);let s=nr();return r.J({range:n,H:!0},(e,t,n)=>{const r=Ee(e[1]),i=new G(r);s=s.add(i)}).next(()=>s)}containsKey(e,t){const n=_e(t.path),r=IDBKeyRange.bound([n],[V(n)],!1,!0);let s=0;return Hi(e).J({index:"documentTargetsIndex",H:!0,range:r},([e,t],n,r)=>{0!==e&&(s++,r.done())}).next(()=>s>0)}ot(e,t){return Wi(e).get(t).next(e=>e?Hs(e):null)}}function Wi(e){return Ye(e,"targets")}function Ji(e){return Ye(e,"targetGlobal")}function Hi(e){return Ye(e,"targetDocuments")}function Yi([e,t],[n,r]){const s=M(e,n);return 0===s?M(t,r):s}class Xi{constructor(e){this.Un=e,this.buffer=new it(Yi),this.Wn=0}Gn(){return++this.Wn}zn(e){const t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Yi(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Zi{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.jn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return null!==this.jn}Hn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.jn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){le(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await re(e)}await this.Hn(3e5)})}}class eo{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return se.resolve(ye.oe);const n=new Xi(t);return this.Jn.forEachTarget(e,e=>n.zn(e.sequenceNumber)).next(()=>this.Jn.Zn(e,e=>n.zn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),se.resolve(Pi)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Pi):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let n,r,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(c=Date.now(),f()<=i.LogLevel.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),se.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e})))}}function to(e,t){return new eo(e,t)}class no{constructor(e,t){this.db=e,this.garbageCollector=to(this,t)}Yn(e){const t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}er(e){let t=0;return this.Zn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(e,n)=>t(n))}addReference(e,t,n){return ro(e,n)}removeReference(e,t,n){return ro(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return ro(e,t)}nr(e,t){return function(e,t){let n=!1;return $i(e).Y(r=>zi(e,r,t).next(e=>(e&&(n=!0),se.resolve(!e)))).next(()=>n)}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.tr(e,(i,o)=>{if(o<=t){const t=this.nr(e,i).next(t=>{if(!t)return s++,n.getEntry(e,i).next(()=>(n.removeEntry(i,O.min()),Hi(e).delete(function(e){return[0,_e(e.path)]}(i))))});r.push(t)}}).next(()=>se.waitFor(r)).next(()=>n.apply(e)).next(()=>s)}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return ro(e,t)}tr(e,t){const n=Hi(e);let r,s=ye.oe;return n.J({index:"documentTargetsIndex"},([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==ye.oe&&t(new G(Ee(r)),s),s=o,r=i):s=ye.oe}).next(()=>{s!==ye.oe&&t(new G(Ee(r)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function ro(e,t){return Hi(e).put(function(e,t){return{targetId:0,path:_e(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class so{constructor(){this.changes=new $n(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,jt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?se.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class io{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return co(e).put(n)}removeEntry(e,t,n){return co(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Qs(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.rr(e,n)))}getEntry(e,t){let n=jt.newInvalidDocument(t);return co(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(lo(t))},(e,r)=>{n=this.ir(t,r)}).next(()=>n)}sr(e,t){let n={size:0,document:jt.newInvalidDocument(t)};return co(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(lo(t))},(e,r)=>{n={document:this.ir(t,r),size:Ui(r)}}).next(()=>n)}getEntries(e,t){let n=jn();return this._r(e,t,(e,t)=>{const r=this.ir(e,t);n=n.insert(e,r)}).next(()=>n)}ar(e,t){let n=jn(),r=new nt(G.comparator);return this._r(e,t,(e,t)=>{const s=this.ir(e,t);n=n.insert(e,s),r=r.insert(e,Ui(t))}).next(()=>({documents:n,ur:r}))}_r(e,t,n){if(t.isEmpty())return se.resolve();let r=new it(fo);t.forEach(e=>r=r.add(e));const s=IDBKeyRange.bound(lo(r.first()),lo(r.last())),i=r.getIterator();let o=i.getNext();return co(e).J({index:"documentKeyIndex",range:s},(e,t,r)=>{const s=G.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&fo(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.$(lo(o)):r.done()}).next(()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,s){const i=t.path,o=[i.popLast().toArray(),i.lastSegment(),Qs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return co(e).U(IDBKeyRange.bound(o,a,!0)).next(e=>{null==s||s.incrementDocumentReadCount(e.length);let n=jn();for(const s of e){const e=this.ir(G.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(Bn(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let s=jn();const i=ho(t,n),o=ho(t,Z.max());return co(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},(e,t,n)=>{const i=this.ir(G.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()}).next(()=>s)}newChangeBuffer(e){return new ao(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return uo(e).get("remoteDocumentGlobalKey").next(e=>(v(!!e),e))}rr(e,t){return uo(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){const e=function(e,t){let n;if(t.document)n=Cs(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=G.fromSegments(t.noDocument.path),r=Ws(t.noDocument.readTime);n=jt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return w();{const e=G.fromSegments(t.unknownDocument.path),r=Ws(t.unknownDocument.version);n=jt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new P(e[0],e[1]);return O.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(O.min()))return e}return jt.newInvalidDocument(e)}}function oo(e){return new io(e)}class ao extends so{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new $n(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){const t=[];let n=0,r=new it((e,t)=>M(e.canonicalString(),t.canonicalString()));return this.changes.forEach((s,i)=>{const o=this.lr.get(s);if(t.push(this.cr.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=$s(this.cr.serializer,i);r=r.add(s.path.popLast());const u=Ui(a);n+=u-o.size,t.push(this.cr.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=$s(this.cr.serializer,i.convertToNoDocument(O.min()));t.push(this.cr.addEntry(e,s,n))}}),r.forEach(n=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.cr.updateMetadata(e,n)),se.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(e=>(this.lr.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:e,ur:t})=>(t.forEach((t,n)=>{this.lr.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function uo(e){return Ye(e,"remoteDocumentGlobal")}function co(e){return Ye(e,"remoteDocumentsV14")}function lo(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function ho(e,t){const n=t.documentKey.path.toArray();return[e,Qs(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function fo(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=M(n[e],r[e]),s)return s;return s=M(n.length,r.length),s||(s=M(n[n.length-2],r[r.length-2]),s||M(n[n.length-1],r[r.length-1]))}class mo{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class go{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&Cr(n.mutation,e,ut.empty(),P.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,nr()).next(()=>t))}getLocalViewOfDocuments(e,t,n=nr()){const r=Yn();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=Jn();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){const n=Yn();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,nr()))}populateOverlays(e,t,n){const r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let s=jn();const i=Zn(),o=Zn();return t.forEach((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof kr)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),Cr(o.mutation,t,o.mutation.getFieldMask(),P.now())):i.set(t.key,ut.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>i.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new mo(t,null!==(n=i.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(e,t){const n=Zn();let r=new nt((e,t)=>e-t),s=nr();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(const s of e)s.keys().forEach(e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||ut.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||nr()).add(e);r=r.insert(s.batchId,a)})}).next(()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=Xn();u.forEach(e=>{if(!s.has(e)){const r=Sr(t.get(e),n.get(e));null!==r&&c.set(e,r),s=s.add(e)}}),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return se.waitFor(i)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return function(e){return G.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):kn(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):se.resolve(Yn());let o=-1,a=s;return i.next(t=>se.forEach(t,(t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?se.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{a=a.insert(t,e)}))).next(()=>this.populateOverlays(e,t,s)).next(()=>this.computeViews(e,a,t,nr())).next(e=>({batchId:o,changes:Hn(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new G(t)).next(e=>{let t=Jn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const s=t.collectionGroup;let i=Jn();return this.indexManager.getCollectionParents(e,s).next(o=>se.forEach(o,o=>{const a=function(e,t){return new Cn(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,o.child(s));return this.getDocumentsMatchingCollectionQuery(e,a,n,r).next(e=>{e.forEach((e,t)=>{i=i.insert(e,t)})})}).next(()=>i))}getDocumentsMatchingCollectionQuery(e,t,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,r))).next(e=>{s.forEach((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,jt.newInvalidDocument(r)))});let n=Jn();return e.forEach((e,r)=>{const i=s.get(e);void 0!==i&&Cr(i.mutation,r,ut.empty(),P.now()),Bn(t,r)&&(n=n.insert(e,r))}),n})}}class po{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return se.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:ps(e.createTime)}}(t)),se.resolve()}getNamedQuery(e,t){return se.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,function(e){return{name:e.name,query:Xs(e.bundledQuery),readTime:ps(e.readTime)}}(t)),se.resolve()}}class yo{constructor(){this.overlays=new nt(G.comparator),this.Ir=new Map}getOverlay(e,t){return se.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Yn();return se.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.ht(e,t,r)}),se.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Ir.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Ir.delete(n)),se.resolve()}getOverlaysForCollection(e,t,n){const r=Yn(),s=t.length+1,i=new G(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return se.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new nt((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=Yn(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Yn(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach((e,t)=>o.set(e,t)),!(o.size()>=r)););return se.resolve(o)}ht(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.Ir.get(r.largestBatchId).delete(n.key);this.Ir.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new qr(t,n));let s=this.Ir.get(t);void 0===s&&(s=nr(),this.Ir.set(t,s)),this.Ir.set(t,s.add(n.key))}}class wo{constructor(){this.sessionToken=lt.EMPTY_BYTE_STRING}getSessionToken(e){return se.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,se.resolve()}}class vo{constructor(){this.Tr=new it(Io.Er),this.dr=new it(Io.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){const n=new Io(e,t);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Vr(new Io(e,t))}mr(e,t){e.forEach(e=>this.removeReference(e,t))}gr(e){const t=new G(new U([])),n=new Io(t,e),r=new Io(t,e+1),s=[];return this.dr.forEachInRange([n,r],e=>{this.Vr(e),s.push(e.key)}),s}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){const t=new G(new U([])),n=new Io(t,e),r=new Io(t,e+1);let s=nr();return this.dr.forEachInRange([n,r],e=>{s=s.add(e.key)}),s}containsKey(e){const t=new Io(e,0),n=this.Tr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Io{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return G.comparator(e.key,t.key)||M(e.wr,t.wr)}static Ar(e,t){return M(e.wr,t.wr)||G.comparator(e.key,t.key)}}class _o{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new it(Io.Er)}checkEmpty(e){return se.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Pr(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.br=this.br.add(new Io(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return se.resolve(i)}lookupMutationBatch(e,t){return se.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.vr(n),s=r<0?0:r;return se.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return se.resolve(0===this.mutationQueue.length?-1:this.Sr-1)}getAllMutationBatches(e){return se.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Io(t,0),r=new Io(t,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([n,r],e=>{const t=this.Dr(e.wr);s.push(t)}),se.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new it(M);return t.forEach(e=>{const t=new Io(e,0),r=new Io(e,Number.POSITIVE_INFINITY);this.br.forEachInRange([t,r],e=>{n=n.add(e.wr)})}),se.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;G.isDocumentKey(s)||(s=s.child(""));const i=new Io(new G(s),0);let o=new it(M);return this.br.forEachWhile(e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.wr)),!0)},i),se.resolve(this.Cr(o))}Cr(e){const t=[];return e.forEach(e=>{const n=this.Dr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){v(0===this.Fr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.br;return se.forEach(t.mutations,r=>{const s=new Io(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.br=n})}On(e){}containsKey(e,t){const n=new Io(t,0),r=this.br.firstAfterOrEqual(n);return se.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,se.resolve()}Fr(e,t){return this.vr(e)}vr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Dr(e){const t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class bo{constructor(e){this.Mr=e,this.docs=new nt(G.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Mr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return se.resolve(n?n.document.mutableCopy():jt.newInvalidDocument(t))}getEntries(e,t){let n=jn();return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():jt.newInvalidDocument(e))}),se.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=jn();const i=t.path,o=new G(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||ee(X(o),n)<=0||(r.has(o.key)||Bn(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return se.resolve(s)}getAllFromCollectionGroup(e,t,n,r){w()}Or(e,t){return se.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new To(this)}getSize(e){return se.resolve(this.size)}}class To extends so{constructor(e){super(),this.cr=e}applyChanges(e){const t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.cr.addEntry(e,r)):this.cr.removeEntry(n)}),se.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}}class Eo{constructor(e){this.persistence=e,this.Nr=new $n(e=>_n(e),bn),this.lastRemoteSnapshotVersion=O.min(),this.highestTargetId=0,this.Lr=0,this.Br=new vo,this.targetCount=0,this.kr=Qi.Bn()}forEachTarget(e,t){return this.Nr.forEach((e,n)=>t(n)),se.resolve()}getLastRemoteSnapshotVersion(e){return se.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return se.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),se.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Lr&&(this.Lr=t),se.resolve()}Kn(e){this.Nr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.kr=new Qi(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,se.resolve()}updateTargetData(e,t){return this.Kn(t),se.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,se.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Nr.forEach((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Nr.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)}),se.waitFor(s).next(()=>r)}getTargetCount(e){return se.resolve(this.targetCount)}getTargetData(e,t){const n=this.Nr.get(t)||null;return se.resolve(n)}addMatchingKeys(e,t,n){return this.Br.Rr(t,n),se.resolve()}removeMatchingKeys(e,t,n){this.Br.mr(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach(t=>{s.push(r.markPotentiallyOrphaned(e,t))}),se.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),se.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Br.yr(t);return se.resolve(n)}containsKey(e,t){return se.resolve(this.Br.containsKey(t))}}class So{constructor(e,t){this.qr={},this.overlays={},this.Qr=new ye(0),this.Kr=!1,this.Kr=!0,this.$r=new wo,this.referenceDelegate=e(this),this.Ur=new Eo(this),this.indexManager=new Di,this.remoteDocumentCache=function(e){return new bo(e)}(e=>this.referenceDelegate.Wr(e)),this.serializer=new Ks(t),this.Gr=new po(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new yo,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.qr[e.toKey()];return n||(n=new _o(t,this.referenceDelegate),this.qr[e.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new xo(this.Qr.next());return this.referenceDelegate.zr(),n(r).next(e=>this.referenceDelegate.jr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Hr(e,t){return se.or(Object.values(this.qr).map(n=>()=>n.containsKey(e,t)))}}class xo extends ne{constructor(e){super(),this.currentSequenceNumber=e}}class Co{constructor(e){this.persistence=e,this.Jr=new vo,this.Yr=null}static Zr(e){return new Co(e)}get Xr(){if(this.Yr)return this.Yr;throw w()}addReference(e,t,n){return this.Jr.addReference(n,t),this.Xr.delete(n.toString()),se.resolve()}removeReference(e,t,n){return this.Jr.removeReference(n,t),this.Xr.add(n.toString()),se.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),se.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(e=>this.Xr.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Xr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return se.forEach(this.Xr,n=>{const r=G.fromPath(n);return this.ei(e,r).next(e=>{e||t.removeEntry(r,O.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(e=>{e?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return se.or([()=>se.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}}class Do{constructor(e,t){this.persistence=e,this.ti=new $n(e=>_e(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=to(this,t)}static Zr(e,t){return new Do(e,t)}zr(){}jr(e){return se.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}Yn(e){const t=this.er(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}er(e){let t=0;return this.Zn(e,e=>{t++}).next(()=>t)}Zn(e,t){return se.forEach(this.ti,(n,r)=>this.nr(e,n,r).next(e=>e?se.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.Or(e,r=>this.nr(e,r,t).next(e=>{e||(n++,s.removeEntry(r,O.min()))})).next(()=>s.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.ti.set(t,e.currentSequenceNumber),se.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),se.resolve()}removeReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),se.resolve()}updateLimboDocument(e,t){return this.ti.set(t,e.currentSequenceNumber),se.resolve()}Wr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=At(e.data.value)),t}nr(e,t,n){return se.or([()=>this.persistence.Hr(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const e=this.ti.get(t);return se.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class No{constructor(e){this.serializer=e}O(e,t,n,r){const s=new ie("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Se,{unique:!0}),e.createObjectStore("documentMutations")}(e),Ao(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=se.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),Ao(e)),i=i.next(()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:O.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s))),n<4&&r>=4&&(0!==n&&(i=i.next(()=>function(e,t){return t.store("mutations").U().next(n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Se,{unique:!0});const r=t.store("mutations"),s=n.map(e=>r.put(e));return se.waitFor(s)})}(e,s))),i=i.next(()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)})),n<5&&r>=5&&(i=i.next(()=>this.ni(s))),n<6&&r>=6&&(i=i.next(()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.ri(s)))),n<7&&r>=7&&(i=i.next(()=>this.ii(s))),n<8&&r>=8&&(i=i.next(()=>this.si(e,s))),n<9&&r>=9&&(i=i.next(()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)})),n<10&&r>=10&&(i=i.next(()=>this.oi(s))),n<11&&r>=11&&(i=i.next(()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),n<12&&r>=12&&(i=i.next(()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Ue});t.createIndex("collectionPathOverlayIndex",Be,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",ze,{unique:!1})}(e)})),n<13&&r>=13&&(i=i.next(()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Ne});t.createIndex("documentKeyIndex",Ae),t.createIndex("collectionGroupIndex",ke)}(e)).next(()=>this._i(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),n<14&&r>=14&&(i=i.next(()=>this.ai(e,s))),n<15&&r>=15&&(i=i.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Ve}).createIndex("sequenceNumberIndex",Pe,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Oe}).createIndex("documentKeyIndex",qe,{unique:!1})}(e))),n<16&&r>=16&&(i=i.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),n<17&&r>=17&&(i=i.next(()=>{!function(e){e.createObjectStore("globals",{keyPath:"name"})}(e)})),i}ri(e){let t=0;return e.store("remoteDocuments").J((e,n)=>{t+=Ui(n)}).next(()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}ni(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next(t=>se.forEach(t,t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",r).next(n=>se.forEach(n,n=>{v(n.userId===t.userId);const r=Js(this.serializer,n);return qi(e,t.userId,r).next(()=>{})}))}))}ii(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(e=>{const r=[];return n.J((n,s)=>{const i=new U(n),o=function(e){return[0,_e(e)]}(i);r.push(t.get(o).next(n=>n?se.resolve():(n=>t.put({targetId:0,path:_e(n),sequenceNumber:e.highestListenSequenceNumber}))(i)))}).next(()=>se.waitFor(r))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:Le});const n=t.store("collectionParents"),r=new Ni,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:_e(r)})}};return t.store("remoteDocuments").J({H:!0},(e,t)=>{const n=new U(e);return s(n.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([e,t,n],r)=>{const i=Ee(t);return s(i.popLast())}))}oi(e){const t=e.store("targets");return t.J((e,n)=>{const r=Hs(n),s=Ys(this.serializer,r);return t.put(s)})}_i(e,t){const n=t.store("remoteDocuments"),r=[];return n.J((e,n)=>{const s=t.store("remoteDocumentsV14"),i=function(e){return e.document?new G(U.fromString(e.document.name).popFirst(5)):e.noDocument?G.fromSegments(e.noDocument.path):e.unknownDocument?G.fromSegments(e.unknownDocument.path):w()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))}).next(()=>se.waitFor(r))}ai(e,t){const n=t.store("mutations"),r=oo(this.serializer),s=new So(Co.Zr,this.serializer.ct);return n.U().next(e=>{const n=new Map;return e.forEach(e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:nr();Js(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),se.forEach(n,(e,n)=>{const i=new l(n),o=ii.lt(this.serializer,i),a=s.getIndexManager(i),u=Bi.lt(i,this.serializer,a,s.referenceDelegate);return new go(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new He(t,ye.oe),e).next()})})}}function Ao(e){e.createObjectStore("targetDocuments",{keyPath:Fe}).createIndex("documentTargetsIndex",Me,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Re,{unique:!0}),e.createObjectStore("targetGlobal")}const ko="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Ro{constructor(e,t,n,r,s,i,o,a,u,c,l=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ui=s,this.window=i,this.document=o,this.ci=u,this.li=c,this.hi=l,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=e=>Promise.resolve(),!Ro.D())throw new b(_.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new no(this,r),this.Ai=t+"main",this.serializer=new Ks(a),this.Ri=new oe(this.Ai,this.hi,new No(this.serializer)),this.$r=new ai,this.Ur=new ji(this.referenceDelegate,this.serializer),this.remoteDocumentCache=oo(this.serializer),this.Gr=new ni,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,!1===c&&g("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new b(_.FAILED_PRECONDITION,ko);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new ye(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){return this.di=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget(async()=>{this.started&&await this.mi()}))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>Mo(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(e=>{e||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(le(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return Fo(e).get("owner").next(e=>se.resolve(this.vi(e)))}Ci(e){return Mo(e).delete(this.clientId)}async Fi(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const t=Ye(e,"clientMetadata");return t.U().next(e=>{const n=this.xi(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return se.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Vi)for(const t of e)this.Vi.removeItem(this.Oi(t.clientId))}}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?se.resolve(!0):Fo(e).get("owner").next(t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new b(_.FAILED_PRECONDITION,ko);return!1}}return!(!this.networkEnabled||!this.inForeground)||Mo(e).U().next(e=>void 0===this.xi(e,5e3).find(e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),await this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new He(e,ye.oe);return this.bi(t).next(()=>this.Ci(t))}),this.Ri.close(),this.qi()}xi(e,t){return e.filter(e=>this.Mi(e.updateTimeMs,t)&&!this.Ni(e.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>Mo(e).U().next(e=>this.xi(e,18e5).map(e=>e.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return Bi.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new ki(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return ii.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,n){m("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=function(e){return 17===e?Je:16===e?We:15===e?je:14===e?Qe:13===e?$e:12===e?Ke:11===e?Ge:void w()}(this.hi);let i;return this.Ri.runTransaction(e,r,s,r=>(i=new He(r,this.Qr?this.Qr.next():ye.oe),"readwrite-primary"===t?this.wi(i).next(e=>!!e||this.Si(i)).next(t=>{if(!t)throw g(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new b(_.FAILED_PRECONDITION,te);return n(i)}).next(e=>this.Di(i).next(()=>e)):this.Ki(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Ki(e){return Fo(e).get("owner").next(e=>{if(null!==e&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)&&!this.vi(e)&&!(this.li||this.allowTabSynchronization&&e.allowTabSynchronization))throw new b(_.FAILED_PRECONDITION,ko)})}Di(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Fo(e).put("owner",t)}static D(){return oe.D()}bi(e){const t=Fo(e);return t.get("owner").next(e=>this.vi(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):se.resolve())}Mi(e,t){const n=Date.now();return!(e<n-t||e>n&&(g(`Detected an update time that is in the future: ${e} > ${n}`),1))}fi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground="visible"===this.document.visibilityState)}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Pi=()=>{this.Li();const e=/(?:Version|Mobile)\/1[456]/;o.isSafari()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{const n=null!==(null===(t=this.Vi)||void 0===t?void 0:t.getItem(this.Oi(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return g("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){g("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch(e){}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Fo(e){return Ye(e,"owner")}function Mo(e){return Ye(e,"clientMetadata")}function Lo(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Vo{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.$i=n,this.Ui=r}static Wi(e,t){let n=nr(),r=nr();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Vo(e,t.fromCache,n,r)}}class Po{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class Oo{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=o.isSafari()?8:ae(o.getUA())>0?6:4}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,n,r){const s={result:null};return this.Yi(e,t).next(e=>{s.result=e}).next(()=>{if(!s.result)return this.Zi(e,t,r,n).next(e=>{s.result=e})}).next(()=>{if(s.result)return;const n=new Po;return this.Xi(e,t,n).next(r=>{if(s.result=r,this.zi)return this.es(e,t,n,r.size)})}).next(()=>s.result)}es(e,t,n,r){return n.documentReadCount<this.ji?(f()<=i.LogLevel.DEBUG&&m("QueryEngine","SDK will not create cache indexes for query:",Un(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),se.resolve()):(f()<=i.LogLevel.DEBUG&&m("QueryEngine","Query:",Un(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Hi*r?(f()<=i.LogLevel.DEBUG&&m("QueryEngine","The SDK decides to create cache indexes for query:",Un(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Fn(t))):se.resolve())}Yi(e,t){if(An(t))return se.resolve(null);let n=Fn(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(t=Pn(t,null,"F"),n=Fn(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{const s=nr(...r);return this.Ji.getDocuments(e,s).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{const i=this.ts(t,r);return this.ns(t,i,s,n.readTime)?this.Yi(e,Pn(t,null,"F")):this.rs(e,i,t,n)}))})))}Zi(e,t,n,r){return An(t)||r.isEqual(O.min())?se.resolve(null):this.Ji.getDocuments(e,n).next(s=>{const o=this.ts(t,s);return this.ns(t,o,n,r)?se.resolve(null):(f()<=i.LogLevel.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Un(t)),this.rs(e,o,t,Y(r,-1)).next(e=>e))})}ts(e,t){let n=new it(Gn(e));return t.forEach((t,r)=>{Bn(e,r)&&(n=n.add(r))}),n}ns(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Xi(e,t,n){return f()<=i.LogLevel.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",Un(t)),this.Ji.getDocumentsMatchingQuery(e,t,Z.min(),n)}rs(e,t,n,r){return this.Ji.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}class qo{constructor(e,t,n,r){this.persistence=e,this.ss=t,this.serializer=r,this.os=new nt(M),this._s=new $n(e=>_n(e),bn),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(n)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new go(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}}function Uo(e,t,n,r){return new qo(e,t,n,r)}async function Bo(e,t){const n=I(e);return await n.persistence.runTransaction("Handle user change","readonly",e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next(s=>(r=s,n.ls(t),n.mutationQueue.getAllMutationBatches(e))).next(t=>{const s=[],i=[];let o=nr();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next(e=>({hs:e,removedBatchIds:s,addedBatchIds:i}))})})}function zo(e){const t=I(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Ur.getLastRemoteSnapshotVersion(e))}function Go(e,t,n){let r=nr(),s=nr();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=jn();return n.forEach((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(O.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):m("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)}),{Ps:r,Is:s}})}function Ko(e,t){const n=I(e);return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}function $o(e,t){const n=I(e);return n.persistence.runTransaction("Allocate target","readwrite",e=>{let r;return n.Ur.getTargetData(e,t).next(s=>s?(r=s,se.resolve(r)):n.Ur.allocateTargetId(e).next(s=>(r=new Gs(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Ur.addTargetData(e,r).next(()=>r))))}).then(e=>{const r=n.os.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.os=n.os.insert(e.targetId,e),n._s.set(t,e.targetId)),e})}async function Qo(e,t,n){const r=I(e),s=r.os.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!le(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.os=r.os.remove(t),r._s.delete(s.target)}function jo(e,t,n){const r=I(e);let s=O.min(),i=nr();return r.persistence.runTransaction("Execute query","readwrite",e=>function(e,t,n){const r=I(e),s=r._s.get(n);return void 0!==s?se.resolve(r.os.get(s)):r.Ur.getTargetData(t,n)}(r,e,Fn(t)).next(t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Ur.getMatchingKeysForTargetId(e,t.targetId).next(e=>{i=e})}).next(()=>r.ss.getDocumentsMatchingQuery(e,t,n?s:O.min(),n?i:nr())).next(e=>(Ho(r,zn(t),e),{documents:e,Ts:i})))}function Wo(e,t){const n=I(e),r=I(n.Ur),s=n.os.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.ot(e,t).next(e=>e?e.target:null))}function Jo(e,t){const n=I(e),r=n.us.get(t)||O.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.cs.getAllFromCollectionGroup(e,t,Y(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(Ho(n,t,e),e))}function Ho(e,t,n){let r=e.us.get(t)||O.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.us.set(t,r)}async function Yo(e,t,n=nr()){const r=await $o(e,Fn(Xs(t.bundledQuery))),s=I(e);return s.persistence.runTransaction("Save named query","readwrite",e=>{const i=ps(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Gr.saveNamedQuery(e,t);const o=r.withResumeToken(lt.EMPTY_BYTE_STRING,i);return s.os=s.os.insert(o.targetId,o),s.Ur.updateTargetData(e,o).next(()=>s.Ur.removeMatchingKeysForTargetId(e,r.targetId)).next(()=>s.Ur.addMatchingKeys(e,n,r.targetId)).next(()=>s.Gr.saveNamedQuery(e,t))})}function Xo(e,t){return`firestore_clients_${e}_${t}`}function Zo(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function ea(e,t){return`firestore_targets_${e}_${t}`}class ta{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Rs(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new b(r.error.code,r.error.message))),i?new ta(e,t,r.state,s):(g("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class na{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Rs(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new b(n.error.code,n.error.message))),s?new na(e,n.state,r):(g("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ra{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=sr();for(let e=0;r&&e<n.activeTargetIds.length;++e)r=Ie(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new ra(e,s):(g("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class sa{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new sa(t.clientId,t.onlineState):(g("SharedClientState",`Failed to parse online state: ${e}`),null)}}class ia{constructor(){this.activeTargetIds=sr()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class oa{constructor(e,t,n,r,s){this.window=e,this.ui=t,this.persistenceKey=n,this.ps=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new nt(M),this.started=!1,this.bs=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=Xo(this.persistenceKey,this.ps),this.vs=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.Ss=this.Ss.insert(this.ps,new ia),this.Cs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.xs=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Os=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Qi();for(const t of e){if(t===this.ps)continue;const e=this.getItem(Xo(this.persistenceKey,t));if(e){const n=ra.Rs(t,e);n&&(this.Ss=this.Ss.insert(n.clientId,n))}}this.Ns();const t=this.storage.getItem(this.xs);if(t){const e=this.Ls(t);e&&this.Bs(e)}for(const e of this.bs)this.ws(e);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,n){this.qs(e,t,n),this.Qs(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){const t=this.storage.getItem(ea(this.persistenceKey,e));if(t){const r=na.Rs(e,t);r&&(n=r.state)}}return t&&this.Ks.fs(e),this.Ns(),n}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(ea(this.persistenceKey,e))}updateQueryState(e,t,n){this.$s(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Qs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){const t=e;if(t.storageArea===this.storage){if(m("SharedClientState","EVENT",t.key,t.newValue),t.key===this.Ds)return void g("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(async()=>{if(this.started){if(null!==t.key)if(this.Cs.test(t.key)){if(null==t.newValue){const e=this.Gs(t.key);return this.zs(e,null)}{const e=this.js(t.key,t.newValue);if(e)return this.zs(e.clientId,e)}}else if(this.Fs.test(t.key)){if(null!==t.newValue){const e=this.Hs(t.key,t.newValue);if(e)return this.Js(e)}}else if(this.Ms.test(t.key)){if(null!==t.newValue){const e=this.Ys(t.key,t.newValue);if(e)return this.Zs(e)}}else if(t.key===this.xs){if(null!==t.newValue){const e=this.Ls(t.newValue);if(e)return this.Bs(e)}}else if(t.key===this.vs){const e=function(e){let t=ye.oe;if(null!=e)try{const n=JSON.parse(e);v("number"==typeof n),t=n}catch(e){g("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==ye.oe&&this.sequenceNumberHandler(e)}else if(t.key===this.Os){const e=this.Xs(t.newValue);await Promise.all(e.map(e=>this.syncEngine.eo(e)))}}else this.bs.push(t)})}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,n){const r=new ta(this.currentUser,e,t,n),s=Zo(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Vs())}Qs(e){const t=Zo(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){const t={clientId:this.ps,onlineState:e};this.storage.setItem(this.xs,JSON.stringify(t))}$s(e,t,n){const r=ea(this.persistenceKey,e),s=new na(e,t,n);this.setItem(r,s.Vs())}Ws(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){const t=this.Cs.exec(e);return t?t[1]:null}js(e,t){const n=this.Gs(e);return ra.Rs(n,t)}Hs(e,t){const n=this.Fs.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ta.Rs(new l(s),r,t)}Ys(e,t){const n=this.Ms.exec(e),r=Number(n[1]);return na.Rs(r,t)}Ls(e){return sa.Rs(e)}Xs(e){return JSON.parse(e)}async Js(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.no(e.batchId,e.state,e.error);m("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){const n=t?this.Ss.insert(e,t):this.Ss.remove(e),r=this.ks(this.Ss),s=this.ks(n),i=[],o=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||o.push(e)}),this.syncEngine.io(i,o).then(()=>{this.Ss=n})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=sr();return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class aa{constructor(){this.so=new ia,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,n){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new ia,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class ua{_o(e){}shutdown(){}}class ca{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ho)e(0)}lo(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ho)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let la=null;function ha(){return null===la?la=268435456+Math.round(2147483648*Math.random()):la++,"0x"+la.toString(16)}const da={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class fa{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}const ma="WebChannelConnection";class ga extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Do=t+"://"+e.host,this.vo=`projects/${n}/databases/${r}`,this.Co="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Fo(){return!1}Mo(e,t,n,r,s){const i=ha(),o=this.xo(e,t.toUriEncodedString());m("RestConnection",`Sending RPC '${e}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(a,r,s),this.No(e,o,a,n).then(t=>(m("RestConnection",`Received RPC '${e}' ${i}: `,t),t),t=>{throw p("RestConnection",`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t})}Lo(e,t,n,r,s,i){return this.Mo(e,t,n,r,s)}Oo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+h,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}xo(e,t){const n=da[e];return`${this.Do}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,n,r){const s=ha();return new Promise((i,o)=>{const a=new u.XhrIo;a.setWithCredentials(!0),a.listenOnce(u.EventType.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case u.ErrorCode.NO_ERROR:const t=a.getResponseJson();m(ma,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case u.ErrorCode.TIMEOUT:m(ma,`RPC '${e}' ${s} timed out`),o(new b(_.DEADLINE_EXCEEDED,"Request time out"));break;case u.ErrorCode.HTTP_ERROR:const n=a.getStatus();if(m(ma,`RPC '${e}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(_).indexOf(t)>=0?t:_.UNKNOWN}(t.status);o(new b(e,t.message))}else o(new b(_.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new b(_.UNAVAILABLE,"Connection failed."));break;default:w()}}finally{m(ma,`RPC '${e}' ${s} completed.`)}});const c=JSON.stringify(r);m(ma,`RPC '${e}' ${s} sending request:`,r),a.send(t,"POST",c,n,15)})}Bo(e,t,n){const r=ha(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=u.createWebChannelTransport(),o=u.getStatEventTarget(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(a.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Oo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const l=s.join("");m(ma,`Creating RPC '${e}' stream ${r}: ${l}`,a);const h=i.createWebChannel(l,a);let d=!1,f=!1;const g=new fa({Io:t=>{f?m(ma,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(m(ma,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),m(ma,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},To:()=>h.close()}),y=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return y(h,u.WebChannel.EventType.OPEN,()=>{f||(m(ma,`RPC '${e}' stream ${r} transport opened.`),g.yo())}),y(h,u.WebChannel.EventType.CLOSE,()=>{f||(f=!0,m(ma,`RPC '${e}' stream ${r} transport closed`),g.So())}),y(h,u.WebChannel.EventType.ERROR,t=>{f||(f=!0,p(ma,`RPC '${e}' stream ${r} transport errored:`,t),g.So(new b(_.UNAVAILABLE,"The operation could not be completed")))}),y(h,u.WebChannel.EventType.MESSAGE,t=>{var n;if(!f){const s=t.data[0];v(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){m(ma,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function(e){const t=zr[e];if(void 0!==t)return $r(t)}(t),s=o.message;void 0===n&&(n=_.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),f=!0,g.So(new b(n,s)),h.close()}else m(ma,`RPC '${e}' stream ${r} received:`,s),g.bo(s)}}),y(o,u.Event.STAT_EVENT,t=>{t.stat===u.Stat.PROXY?m(ma,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===u.Stat.NOPROXY&&m(ma,`RPC '${e}' stream ${r} detected no buffering proxy`)}),setTimeout(()=>{g.wo()},0),g}}function pa(){return"undefined"!=typeof window?window:null}function ya(){return"undefined"!=typeof document?document:null}function wa(e){return new hs(e,!0)}class va{constructor(e,t,n=1e3,r=1.5,s=6e4){this.ui=e,this.timerId=t,this.ko=n,this.qo=r,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();const t=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),r=Math.max(0,t-n);r>0&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,r,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){null!==this.$o&&(this.$o.skipDelay(),this.$o=null)}cancel(){null!==this.$o&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}class Ia{constructor(e,t,n,r,s,i,o,a){this.ui=e,this.Ho=n,this.Jo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new va(e,t)}n_(){return 1===this.state||5===this.state||this.r_()}r_(){return 2===this.state||3===this.state}start(){this.e_=0,4!==this.state?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&null===this.Zo&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(e,t){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,4!==e?this.t_.reset():t&&t.code===_.RESOURCE_EXHAUSTED?(g(t.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===_.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.mo(t)}l_(){}auth(){this.state=1;const e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.Yo===t&&this.P_(e,n)},t=>{e(()=>{const e=new b(_.UNKNOWN,"Fetching auth token failed: "+t.message);return this.I_(e)})})}P_(e,t){const n=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{n(()=>this.listener.Eo())}),this.stream.Ro(()=>{n(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(e=>{n(()=>this.I_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.e_?this.E_(e):this.onNext(e))})}i_(){this.state=5,this.t_.Go(async()=>{this.state=0,this.start()})}I_(e){return m("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class _a extends Ia{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:w()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(v(void 0===t||"string"==typeof t),lt.fromBase64String(t||"")):(v(void 0===t||t instanceof Buffer||t instanceof Uint8Array),lt.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?_.UNKNOWN:$r(e.code);return new b(t,e.message||"")}(o);n=new rs(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=_s(e,r.document.name),i=ps(r.document.updateTime),o=r.document.createTime?ps(r.document.createTime):O.min(),a=new $t({mapValue:{fields:r.document.fields}}),u=jt.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new ts(c,l,u.key,u)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=_s(e,r.document),i=r.readTime?ps(r.readTime):O.min(),o=jt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new ts([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=_s(e,r.document),i=r.removedTargetIds||[];n=new ts([],i,s,null)}else{if(!("filter"in t))return w();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new Br(r,s),o=e.targetId;n=new ns(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return O.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?O.min():t.readTime?ps(t.readTime):O.min()}(e);return this.listener.d_(t,n)}A_(e){const t={};t.database=Es(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=Tn(r)?{documents:As(e,r)}:{query:ks(e,r)._t},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=ms(e,t.resumeToken);const r=ds(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(O.min())>0){n.readTime=fs(e,t.snapshotVersion.toTimestamp());const r=ds(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return w()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.a_(t)}R_(e){const t={};t.database=Es(this.serializer),t.removeTarget=e,this.a_(t)}}class ba extends Ia{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return v(!!e.streamToken),this.lastStreamToken=e.streamToken,v(!e.writeResults||0===e.writeResults.length),this.listener.f_()}onNext(e){v(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();const t=function(e,t){return e&&e.length>0?(v(void 0!==t),e.map(e=>function(e,t){let n=e.updateTime?ps(e.updateTime):ps(t);return n.isEqual(O.min())&&(n=ps(t)),new _r(n,e.transformResults||[])}(e,t))):[]}(e.writeResults,e.commitTime),n=ps(e.commitTime);return this.listener.g_(n,t)}p_(){const e={};e.database=Es(this.serializer),this.a_(e)}m_(e){const t={streamToken:this.lastStreamToken,writes:e.map(e=>Ds(this.serializer,e))};this.a_(t)}}class Ta extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.y_=!1}w_(){if(this.y_)throw new b(_.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,n,r){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,i])=>this.connection.Mo(e,ws(t,n),r,s,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===_.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(_.UNKNOWN,e.toString())})}Lo(e,t,n,r,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,o])=>this.connection.Lo(e,ws(t,n),r,i,o,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===_.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(_.UNKNOWN,e.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class Ea{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){0===this.S_&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){"Online"===this.state?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,"Online"===e&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(g(t),this.D_=!1):m("OnlineStateTracker",t)}x_(){null!==this.b_&&(this.b_.cancel(),this.b_=null)}}class Sa{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(e=>{n.enqueueAndForget(async()=>{Ma(this)&&(m("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=I(e);t.L_.add(4),await Ca(t),t.q_.set("Unknown"),t.L_.delete(4),await xa(t)}(this))})}),this.q_=new Ea(n,r)}}async function xa(e){if(Ma(e))for(const t of e.B_)await t(!0)}async function Ca(e){for(const t of e.B_)await t(!1)}function Da(e,t){const n=I(e);n.N_.has(t.targetId)||(n.N_.set(t.targetId,t),Fa(n)?Ra(n):Za(n).r_()&&Aa(n,t))}function Na(e,t){const n=I(e),r=Za(n);n.N_.delete(t),r.r_()&&ka(n,t),0===n.N_.size&&(r.r_()?r.o_():Ma(n)&&n.q_.set("Unknown"))}function Aa(e,t){if(e.Q_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(O.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}Za(e).A_(t)}function ka(e,t){e.Q_.xe(t),Za(e).R_(t)}function Ra(e){e.Q_=new is({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.N_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),Za(e).start(),e.q_.v_()}function Fa(e){return Ma(e)&&!Za(e).n_()&&e.N_.size>0}function Ma(e){return 0===I(e).L_.size}function La(e){e.Q_=void 0}async function Va(e){e.q_.set("Online")}async function Pa(e){e.N_.forEach((t,n)=>{Aa(e,t)})}async function Oa(e,t){La(e),Fa(e)?(e.q_.M_(t),Ra(e)):e.q_.set("Unknown")}async function qa(e,t,n){if(e.q_.set("Online"),t instanceof rs&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.N_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.N_.delete(r),e.Q_.removeTarget(r))}(e,t)}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Ua(e,n)}else if(t instanceof ts?e.Q_.Ke(t):t instanceof ns?e.Q_.He(t):e.Q_.We(t),!n.isEqual(O.min()))try{const t=await zo(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Q_.rt(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.N_.get(r);s&&e.N_.set(r,s.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{const r=e.N_.get(t);if(!r)return;e.N_.set(t,r.withResumeToken(lt.EMPTY_BYTE_STRING,r.snapshotVersion)),ka(e,t);const s=new Gs(r.target,t,n,r.sequenceNumber);Aa(e,s)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){m("RemoteStore","Failed to raise snapshot:",t),await Ua(e,t)}}async function Ua(e,t,n){if(!le(t))throw t;e.L_.add(1),await Ca(e),e.q_.set("Offline"),n||(n=()=>zo(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.L_.delete(1),await xa(e)})}function Ba(e,t){return t().catch(n=>Ua(e,n,t))}async function za(e){const t=I(e),n=eu(t);let r=t.O_.length>0?t.O_[t.O_.length-1].batchId:-1;for(;Ga(t);)try{const e=await Ko(t.localStore,r);if(null===e){0===t.O_.length&&n.o_();break}r=e.batchId,Ka(t,e)}catch(e){await Ua(t,e)}$a(t)&&Qa(t)}function Ga(e){return Ma(e)&&e.O_.length<10}function Ka(e,t){e.O_.push(t);const n=eu(e);n.r_()&&n.V_&&n.m_(t.mutations)}function $a(e){return Ma(e)&&!eu(e).n_()&&e.O_.length>0}function Qa(e){eu(e).start()}async function ja(e){eu(e).p_()}async function Wa(e){const t=eu(e);for(const n of e.O_)t.m_(n.mutations)}async function Ja(e,t,n){const r=e.O_.shift(),s=Or.from(r,t,n);await Ba(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await za(e)}async function Ha(e,t){t&&eu(e).V_&&await async function(e,t){if(function(e){return Kr(e)&&e!==_.ABORTED}(t.code)){const n=e.O_.shift();eu(e).s_(),await Ba(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await za(e)}}(e,t),$a(e)&&Qa(e)}async function Ya(e,t){const n=I(e);n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");const r=Ma(n);n.L_.add(3),await Ca(n),r&&n.q_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.L_.delete(3),await xa(n)}async function Xa(e,t){const n=I(e);t?(n.L_.delete(2),await xa(n)):t||(n.L_.add(2),await Ca(n),n.q_.set("Unknown"))}function Za(e){return e.K_||(e.K_=function(e,t,n){const r=I(e);return r.w_(),new _a(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Eo:Va.bind(null,e),Ro:Pa.bind(null,e),mo:Oa.bind(null,e),d_:qa.bind(null,e)}),e.B_.push(async t=>{t?(e.K_.s_(),Fa(e)?Ra(e):e.q_.set("Unknown")):(await e.K_.stop(),La(e))})),e.K_}function eu(e){return e.U_||(e.U_=function(e,t,n){const r=I(e);return r.w_(),new ba(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Eo:()=>Promise.resolve(),Ro:ja.bind(null,e),mo:Ha.bind(null,e),f_:Wa.bind(null,e),g_:Ja.bind(null,e)}),e.B_.push(async t=>{t?(e.U_.s_(),await za(e)):(await e.U_.stop(),e.O_.length>0&&(m("RemoteStore",`Stopping write stream with ${e.O_.length} pending writes`),e.O_=[]))})),e.U_}class tu{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new T,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new tu(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new b(_.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function nu(e,t){if(g("AsyncQueue",`${t}: ${e}`),le(e))return new b(_.UNAVAILABLE,`${t}: ${e}`);throw e}class ru{constructor(e){this.comparator=e?(t,n)=>e(t,n)||G.comparator(t.key,n.key):(e,t)=>G.comparator(e.key,t.key),this.keyedMap=Jn(),this.sortedSet=new nt(this.comparator)}static emptySet(e){return new ru(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof ru))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new ru;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class su{constructor(){this.W_=new nt(G.comparator)}track(e){const t=e.doc.key,n=this.W_.get(t);n?0!==e.type&&3===n.type?this.W_=this.W_.insert(t,e):3===e.type&&1!==n.type?this.W_=this.W_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.W_=this.W_.remove(t):1===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):w():this.W_=this.W_.insert(t,e)}G_(){const e=[];return this.W_.inorderTraversal((t,n)=>{e.push(n)}),e}}class iu{constructor(e,t,n,r,s,i,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new iu(e,t,ru.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&On(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class ou{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}}class au{constructor(){this.queries=uu(),this.onlineState="Unknown",this.Y_=new Set}terminate(){!function(e,t){const n=I(e),r=n.queries;n.queries=uu(),r.forEach((e,n)=>{for(const e of n.j_)e.onError(t)})}(this,new b(_.ABORTED,"Firestore shutting down"))}}function uu(){return new $n(e=>qn(e),On)}async function cu(e,t){const n=I(e);let r=3;const s=t.query;let i=n.queries.get(s);i?!i.H_()&&t.J_()&&(r=2):(i=new ou,r=t.J_()?0:1);try{switch(r){case 0:i.z_=await n.onListen(s,!0);break;case 1:i.z_=await n.onListen(s,!1);break;case 2:await n.onFirstRemoteStoreListen(s)}}catch(e){const n=nu(e,`Initialization of query '${Un(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,i),i.j_.push(t),t.Z_(n.onlineState),i.z_&&t.X_(i.z_)&&fu(n)}async function lu(e,t){const n=I(e),r=t.query;let s=3;const i=n.queries.get(r);if(i){const e=i.j_.indexOf(t);e>=0&&(i.j_.splice(e,1),0===i.j_.length?s=t.J_()?0:1:!i.H_()&&t.J_()&&(s=2))}switch(s){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function hu(e,t){const n=I(e);let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.j_)t.X_(e)&&(r=!0);s.z_=e}}r&&fu(n)}function du(e,t,n){const r=I(e),s=r.queries.get(t);if(s)for(const e of s.j_)e.onError(n);r.queries.delete(t)}function fu(e){e.Y_.forEach(e=>{e.next()})}var mu,gu;(gu=mu||(mu={})).ea="default",gu.Cache="cache";class pu{constructor(e,t,n){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new iu(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){if(!e.fromCache)return!0;if(!this.J_())return!0;const n="Offline"!==t;return(!this.options._a||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ia(e){if(e.docChanges.length>0)return!0;const t=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}oa(e){e=iu.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==mu.Cache}}class yu{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}}class wu{constructor(e){this.serializer=e}Es(e){return _s(this.serializer,e)}ds(e){return e.metadata.exists?Cs(this.serializer,e.document,!1):jt.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return ps(e)}}class vu{constructor(e,t,n){this.ca=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Iu(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;const n=U.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){const t=new Map,n=new wu(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.Es(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||nr()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=I(e);let i=nr(),o=jn();for(const e of n){const n=t.Es(e.metadata.name);e.document&&(i=i.add(n));const r=t.ds(e);r.setReadTime(t.As(e.metadata.readTime)),o=o.insert(n,r)}const a=s.cs.newChangeBuffer({trackRemovals:!0}),u=await $o(s,function(e){return Fn(Nn(U.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",e=>Go(e,a,o).next(t=>(a.apply(e),t)).next(t=>s.Ur.removeMatchingKeysForTargetId(e,u.targetId).next(()=>s.Ur.addMatchingKeys(e,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(e,t.Ps,t.Is)).next(()=>t.Ps)))}(this.localStore,new wu(this.serializer),this.documents,this.ca.id),t=this.ha(this.documents);for(const e of this.queries)await Yo(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:e}}}function Iu(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class _u{constructor(e){this.key=e}}class bu{constructor(e){this.key=e}}class Tu{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=nr(),this.mutatedKeys=nr(),this.Aa=Gn(e),this.Ra=new ru(this.Aa)}get Va(){return this.Ta}ma(e,t){const n=t?t.fa:new su,r=t?t.Ra:this.Ra;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{const c=r.get(e),l=Bn(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.ga(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Aa(l,a)>0||u&&this.Aa(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))}),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Ra:i,fa:n,ns:o,mutatedKeys:s}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const s=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;const i=e.fa.G_();i.sort((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return w()}};return n(e)-n(t)}(e.type,t.type)||this.Aa(e.doc,t.doc)),this.pa(n),r=null!=r&&r;const o=t&&!r?this.ya():[],a=0===this.da.size&&this.current&&!r?1:0,u=a!==this.Ea;return this.Ea=a,0!==i.length||u?{snapshot:new iu(this.query,e.Ra,s,i,e.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:o}:{wa:o}}Z_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new su,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(e=>this.Ta=this.Ta.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ta=this.Ta.delete(e)),this.current=e.current)}ya(){if(!this.current)return[];const e=this.da;this.da=nr(),this.Ra.forEach(e=>{this.Sa(e.key)&&(this.da=this.da.add(e.key))});const t=[];return e.forEach(e=>{this.da.has(e)||t.push(new bu(e))}),this.da.forEach(n=>{e.has(n)||t.push(new _u(n))}),t}ba(e){this.Ta=e.Ts,this.da=nr();const t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return iu.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,0===this.Ea,this.hasCachedResults)}}class Eu{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Su{constructor(e){this.key=e,this.va=!1}}class xu{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Ca={},this.Fa=new $n(e=>qn(e),On),this.Ma=new Map,this.xa=new Set,this.Oa=new nt(G.comparator),this.Na=new Map,this.La=new vo,this.Ba={},this.ka=new Map,this.qa=Qi.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return!0===this.Qa}}async function Cu(e,t,n=!0){const r=nc(e);let s;const i=r.Fa.get(t);return i?(r.sharedClientState.addLocalQueryTarget(i.targetId),s=i.view.Da()):s=await Nu(r,t,n,!0),s}async function Du(e,t){const n=nc(e);await Nu(n,t,!0,!1)}async function Nu(e,t,n,r){const s=await $o(e.localStore,Fn(t)),i=s.targetId,o=e.sharedClientState.addLocalQueryTarget(i,n);let a;return r&&(a=await Au(e,t,i,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&Da(e.remoteStore,s),a}async function Au(e,t,n,r,s){e.Ka=(t,n,r)=>async function(e,t,n,r){let s=t.view.ma(n);s.ns&&(s=await jo(e.localStore,t.query,!1).then(({documents:e})=>t.view.ma(e,s)));const i=r&&r.targetChanges.get(t.targetId),o=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(s,e.isPrimaryClient,i,o);return zu(e,t.targetId,a.wa),a.snapshot}(e,t,n,r);const i=await jo(e.localStore,t,!0),o=new Tu(t,i.Ts),a=o.ma(i.documents),u=es.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),c=o.applyChanges(a,e.isPrimaryClient,u);zu(e,n,c.wa);const l=new Eu(t,n,o);return e.Fa.set(t,l),e.Ma.has(n)?e.Ma.get(n).push(t):e.Ma.set(n,[t]),c.snapshot}async function ku(e,t,n){const r=I(e),s=r.Fa.get(t),i=r.Ma.get(s.targetId);if(i.length>1)return r.Ma.set(s.targetId,i.filter(e=>!On(e,t))),void r.Fa.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(s.targetId),r.sharedClientState.isActiveQueryTarget(s.targetId)||await Qo(r.localStore,s.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(s.targetId),n&&Na(r.remoteStore,s.targetId),Uu(r,s.targetId)}).catch(re)):(Uu(r,s.targetId),await Qo(r.localStore,s.targetId,!0))}async function Ru(e,t){const n=I(e),r=n.Fa.get(t),s=n.Ma.get(r.targetId);n.isPrimaryClient&&1===s.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),Na(n.remoteStore,r.targetId))}async function Fu(e,t){const n=I(e);try{const e=await function(e,t){const n=I(e),r=t.snapshotVersion;let s=n.os;return n.persistence.runTransaction("Apply remote event","readwrite-primary",e=>{const i=n.cs.newChangeBuffer({trackRemovals:!0});s=n.os;const o=[];t.targetChanges.forEach((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Ur.removeMatchingKeys(e,i.removedDocuments,a).next(()=>n.Ur.addMatchingKeys(e,i.addedDocuments,a)));let c=u.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?c=c.withResumeToken(lt.EMPTY_BYTE_STRING,O.min()).withLastLimboFreeSnapshotVersion(O.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Ur.updateTargetData(e,c))});let a=jn(),u=nr();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))}),o.push(Go(e,i,t.documentUpdates).next(e=>{a=e.Ps,u=e.Is})),!r.isEqual(O.min())){const t=n.Ur.getLastRemoteSnapshotVersion(e).next(t=>n.Ur.setTargetsMetadata(e,e.currentSequenceNumber,r));o.push(t)}return se.waitFor(o).next(()=>i.apply(e)).next(()=>n.localDocuments.getLocalViewOfDocuments(e,a,u)).next(()=>a)}).then(e=>(n.os=s,e))}(n.localStore,t);t.targetChanges.forEach((e,t)=>{const r=n.Na.get(t);r&&(v(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.va=!0:e.modifiedDocuments.size>0?v(r.va):e.removedDocuments.size>0&&(v(r.va),r.va=!1))}),await $u(n,e,t)}catch(e){await re(e)}}function Mu(e,t,n){const r=I(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.Fa.forEach((n,r)=>{const s=r.view.Z_(t);s.snapshot&&e.push(s.snapshot)}),function(e,t){const n=I(e);n.onlineState=t;let r=!1;n.queries.forEach((e,n)=>{for(const e of n.j_)e.Z_(t)&&(r=!0)}),r&&fu(n)}(r.eventManager,t),e.length&&r.Ca.d_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Lu(e,t,n){const r=I(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Na.get(t),i=s&&s.key;if(i){let e=new nt(G.comparator);e=e.insert(i,jt.newNoDocument(i,O.min()));const n=nr().add(i),s=new Zr(O.min(),new Map,new nt(M),e,n);await Fu(r,s),r.Oa=r.Oa.remove(i),r.Na.delete(t),Ku(r)}else await Qo(r.localStore,t,!1).then(()=>Uu(r,t,n)).catch(re)}async function Vu(e,t){const n=I(e),r=t.batch.batchId;try{const e=await function(e,t){const n=I(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const r=t.batch.keys(),s=n.cs.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=se.resolve();return i.forEach(e=>{o=o.next(()=>r.getEntry(t,e)).next(t=>{const i=n.docVersions.get(e);v(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),o.next(()=>e.mutationQueue.removeMutationBatch(t,s))}(n,e,t,s).next(()=>s.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=nr();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))})}(n.localStore,t);qu(n,r,null),Ou(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await $u(n,e)}catch(e){await re(e)}}async function Pu(e,t,n){const r=I(e);try{const e=await function(e,t){const n=I(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next(t=>(v(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t))).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)).next(()=>n.localDocuments.getDocuments(e,r))})}(r.localStore,t);qu(r,t,n),Ou(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await $u(r,e)}catch(n){await re(n)}}function Ou(e,t){(e.ka.get(t)||[]).forEach(e=>{e.resolve()}),e.ka.delete(t)}function qu(e,t,n){const r=I(e);let s=r.Ba[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Ba[r.currentUser.toKey()]=s}}function Uu(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Ma.get(t))e.Fa.delete(r),n&&e.Ca.$a(r,n);e.Ma.delete(t),e.isPrimaryClient&&e.La.gr(t).forEach(t=>{e.La.containsKey(t)||Bu(e,t)})}function Bu(e,t){e.xa.delete(t.path.canonicalString());const n=e.Oa.get(t);null!==n&&(Na(e.remoteStore,n),e.Oa=e.Oa.remove(t),e.Na.delete(n),Ku(e))}function zu(e,t,n){for(const r of n)r instanceof _u?(e.La.addReference(r.key,t),Gu(e,r)):r instanceof bu?(m("SyncEngine","Document no longer in limbo: "+r.key),e.La.removeReference(r.key,t),e.La.containsKey(r.key)||Bu(e,r.key)):w()}function Gu(e,t){const n=t.key,r=n.path.canonicalString();e.Oa.get(n)||e.xa.has(r)||(m("SyncEngine","New document in limbo: "+n),e.xa.add(r),Ku(e))}function Ku(e){for(;e.xa.size>0&&e.Oa.size<e.maxConcurrentLimboResolutions;){const t=e.xa.values().next().value;e.xa.delete(t);const n=new G(U.fromString(t)),r=e.qa.next();e.Na.set(r,new Su(n)),e.Oa=e.Oa.insert(n,r),Da(e.remoteStore,new Gs(Fn(Nn(n.path)),r,"TargetPurposeLimboResolution",ye.oe))}}async function $u(e,t,n){const r=I(e),s=[],i=[],o=[];r.Fa.isEmpty()||(r.Fa.forEach((e,a)=>{o.push(r.Ka(a,t,n).then(e=>{var t;if((e||n)&&r.isPrimaryClient){const s=e?!e.fromCache:null===(t=null==n?void 0:n.targetChanges.get(a.targetId))||void 0===t?void 0:t.current;r.sharedClientState.updateQueryState(a.targetId,s?"current":"not-current")}if(e){s.push(e);const t=Vo.Wi(a.targetId,e);i.push(t)}}))}),await Promise.all(o),r.Ca.d_(s),await async function(e,t){const n=I(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",e=>se.forEach(t,t=>se.forEach(t.$i,r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r)).next(()=>se.forEach(t.Ui,r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))}catch(e){if(!le(e))throw e;m("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.os.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.os=n.os.insert(t,s)}}}(r.localStore,i))}async function Qu(e,t){const n=I(e);if(!n.currentUser.isEqual(t)){m("SyncEngine","User change. New user:",t.toKey());const e=await Bo(n.localStore,t);n.currentUser=t,function(e){e.ka.forEach(e=>{e.forEach(e=>{e.reject(new b(_.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.ka.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await $u(n,e.hs)}}function ju(e,t){const n=I(e),r=n.Na.get(t);if(r&&r.va)return nr().add(r.key);{let e=nr();const r=n.Ma.get(t);if(!r)return e;for(const t of r){const r=n.Fa.get(t);e=e.unionWith(r.view.Va)}return e}}async function Wu(e,t){const n=I(e),r=await jo(n.localStore,t.query,!0),s=t.view.ba(r);return n.isPrimaryClient&&zu(n,t.targetId,s.wa),s}async function Ju(e,t){const n=I(e);return Jo(n.localStore,t).then(e=>$u(n,e))}async function Hu(e,t,n,r){const s=I(e),i=await function(e,t){const n=I(e),r=I(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",e=>r.Mn(e,t).next(t=>t?n.localDocuments.getDocuments(e,t):se.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await za(s.remoteStore):"acknowledged"===n||"rejected"===n?(qu(s,t,r||null),Ou(s,t),function(e,t){I(I(e).mutationQueue).On(t)}(s.localStore,t)):w(),await $u(s,i)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Yu(e,t,n){const r=I(e),s=[],i=[];for(const e of t){let t;const n=r.Ma.get(e);if(n&&0!==n.length){t=await $o(r.localStore,Fn(n[0]));for(const e of n){const t=r.Fa.get(e),n=await Wu(r,t);n.snapshot&&i.push(n.snapshot)}}else{const n=await Wo(r.localStore,e);t=await $o(r.localStore,n),await Au(r,Xu(n),e,!1,t.resumeToken)}s.push(t)}return r.Ca.d_(i),s}function Xu(e){return Dn(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Zu(e){return function(e){return I(I(e).persistence).Qi()}(I(e).localStore)}async function ec(e,t,n,r){const s=I(e);if(s.Qa)return void m("SyncEngine","Ignoring unexpected query state notification.");const i=s.Ma.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Jo(s.localStore,zn(i[0])),r=Zr.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,lt.EMPTY_BYTE_STRING);await $u(s,e,r);break}case"rejected":await Qo(s.localStore,t,!0),Uu(s,t,r);break;default:w()}}async function tc(e,t,n){const r=nc(e);if(r.Qa){for(const e of t){if(r.Ma.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){m("SyncEngine","Adding an already active target "+e);continue}const t=await Wo(r.localStore,e),n=await $o(r.localStore,t);await Au(r,Xu(t),n.targetId,!1,n.resumeToken),Da(r.remoteStore,n)}for(const e of n)r.Ma.has(e)&&await Qo(r.localStore,e,!1).then(()=>{Na(r.remoteStore,e),Uu(r,e)}).catch(re)}}function nc(e){const t=I(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Fu.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=ju.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Lu.bind(null,t),t.Ca.d_=hu.bind(null,t.eventManager),t.Ca.$a=du.bind(null,t.eventManager),t}function rc(e){const t=I(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Vu.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Pu.bind(null,t),t}class sc{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=wa(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),await this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)}ja(e,t){return null}Ha(e,t){return null}za(e){return Uo(this.persistence,new Oo,e.initialUser,this.serializer)}Ga(e){return new So(Co.Zr,this.serializer)}Wa(e){return new aa}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}sc.provider={build:()=>new sc};class ic extends sc{constructor(e){super(),this.cacheSizeBytes=e}ja(e,t){v(this.persistence.referenceDelegate instanceof Do);const n=this.persistence.referenceDelegate.garbageCollector;return new Zi(n,e.asyncQueue,t)}Ga(e){const t=void 0!==this.cacheSizeBytes?Oi.withCacheSize(this.cacheSizeBytes):Oi.DEFAULT;return new So(e=>Do.Zr(e,t),this.serializer)}}class oc extends sc{constructor(e,t,n){super(),this.Ja=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ja.initialize(this,e),await rc(this.Ja.syncEngine),await za(this.Ja.remoteStore),await this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}za(e){return Uo(this.persistence,new Oo,e.initialUser,this.serializer)}ja(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new Zi(n,e.asyncQueue,t)}Ha(e,t){const n=new pe(t,this.persistence);return new ge(e.asyncQueue,n)}Ga(e){const t=Lo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Oi.withCacheSize(this.cacheSizeBytes):Oi.DEFAULT;return new Ro(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,pa(),ya(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(e){return new aa}}class ac extends oc{constructor(e,t){super(e,t,!1),this.Ja=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Ja.syncEngine;this.sharedClientState instanceof oa&&(this.sharedClientState.syncEngine={no:Hu.bind(null,t),ro:ec.bind(null,t),io:tc.bind(null,t),Qi:Zu.bind(null,t),eo:Ju.bind(null,t)},await this.sharedClientState.start()),await this.persistence.yi(async e=>{await async function(e,t){const n=I(e);if(nc(n),rc(n),!0===t&&!0!==n.Qa){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Yu(n,e.toArray());n.Qa=!0,await Xa(n.remoteStore,!0);for(const e of t)Da(n.remoteStore,e)}else if(!1===t&&!1!==n.Qa){const e=[];let t=Promise.resolve();n.Ma.forEach((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then(()=>(Uu(n,s),Qo(n.localStore,s,!0))),Na(n.remoteStore,s)}),await t,await Yu(n,e),function(e){const t=I(e);t.Na.forEach((e,n)=>{Na(t.remoteStore,n)}),t.La.pr(),t.Na=new Map,t.Oa=new nt(G.comparator)}(n),n.Qa=!1,await Xa(n.remoteStore,!1)}}(this.Ja.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Wa(e){const t=pa();if(!oa.D(t))throw new b(_.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Lo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new oa(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class uc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Mu(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Qu.bind(null,this.syncEngine),await Xa(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new au}createDatastore(e){const t=wa(e.databaseInfo.databaseId),n=function(e){return new ga(e)}(e.databaseInfo);return function(e,t,n,r){return new Ta(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,r,s){return new Sa(e,t,n,r,s)}(this.localStore,this.datastore,e.asyncQueue,e=>Mu(this.syncEngine,e,0),ca.D()?new ca:new ua)}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new xu(e,t,n,r,s,i);return o&&(a.Qa=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){const t=I(e);m("RemoteStore","RemoteStore shutting down."),t.L_.add(5),await Ca(t),t.k_.shutdown(),t.q_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate(),null===(t=this.eventManager)||void 0===t||t.terminate()}}function cc(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}uc.provider={build:()=>new uc};class lc{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):g("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class hc{constructor(e,t){this.Xa=e,this.serializer=t,this.metadata=new T,this.buffer=new Uint8Array,this.eu=new TextDecoder("utf-8"),this.tu().then(e=>{e&&e.ua()?this.metadata.resolve(e.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.aa)}`))},e=>this.metadata.reject(e))}close(){return this.Xa.cancel()}async getMetadata(){return this.metadata.promise}async Ua(){return await this.getMetadata(),this.tu()}async tu(){const e=await this.nu();if(null===e)return null;const t=this.eu.decode(e),n=Number(t);isNaN(n)&&this.ru(`length string (${t}) is not valid number`);const r=await this.iu(n);return new yu(JSON.parse(r),e.length+n)}su(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async nu(){for(;this.su()<0&&!await this.ou(););if(0===this.buffer.length)return null;const e=this.su();e<0&&this.ru("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async iu(e){for(;this.buffer.length<e;)await this.ou()&&this.ru("Reached the end of bundle when more is expected.");const t=this.eu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ru(e){throw this.Xa.cancel(),new Error(`Invalid bundle format: ${e}`)}async ou(){const e=await this.Xa.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class dc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new b(_.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function(e,t){const n=I(e),r={documents:t.map(e=>Is(n.serializer,e))},s=await n.Lo("BatchGetDocuments",n.serializer.databaseId,U.emptyPath(),r,t.length),i=new Map;s.forEach(e=>{const t=function(e,t){return"found"in t?function(e,t){v(!!t.found),t.found.name,t.found.updateTime;const n=_s(e,t.found.name),r=ps(t.found.updateTime),s=t.found.createTime?ps(t.found.createTime):O.min(),i=new $t({mapValue:{fields:t.found.fields}});return jt.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){v(!!t.missing),v(!!t.readTime);const n=_s(e,t.missing),r=ps(t.readTime);return jt.newNoDocument(n,r)}(e,t):w()}(n.serializer,e);i.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{const t=i.get(e.toString());v(!!t),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Lr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{const n=G.fromPath(t);this.mutations.push(new Vr(n,this.precondition(n)))}),await async function(e,t){const n=I(e),r={writes:t.map(e=>Ds(n.serializer,e))};await n.Mo("Commit",n.serializer.databaseId,U.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw w();t=O.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new b(_.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(O.min())?br.exists(!1):br.updateTime(t):br.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(O.min()))throw new b(_.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return br.updateTime(t)}return br.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class fc{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this._u=n.maxAttempts,this.t_=new va(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go(async()=>{const e=new dc(this.datastore),t=this.cu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.lu(e)}))}).catch(e=>{this.lu(e)})})}cu(e){try{const t=this.updateFunction(e);return!we(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}lu(e){this._u>0&&this.hu(e)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(e)}hu(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Kr(t)}return!1}}class mc{constructor(e,t,n,r,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=l.UNAUTHENTICATED,this.clientId=F.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new T;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=nu(t,"Failed to shutdown persistence");e.reject(n)}}),e.promise}}async function gc(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await Bo(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function pc(e,t){e.asyncQueue.verifyOperationInProgress();const n=await yc(e);m("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>Ya(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>Ya(t.remoteStore,n)),e._onlineComponents=t}async function yc(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{await gc(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!function(e){return"FirebaseError"===e.name?e.code===_.FAILED_PRECONDITION||e.code===_.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}(n))throw n;p("Error using user provided cache. Falling back to memory cache: "+n),await gc(e,new sc)}}else m("FirestoreClient","Using default OfflineComponentProvider"),await gc(e,new sc);return e._offlineComponents}async function wc(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),await pc(e,e._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),await pc(e,new uc))),e._onlineComponents}function vc(e){return yc(e).then(e=>e.persistence)}function Ic(e){return yc(e).then(e=>e.localStore)}function _c(e){return wc(e).then(e=>e.remoteStore)}function bc(e){return wc(e).then(e=>e.syncEngine)}function Tc(e){return wc(e).then(e=>e.datastore)}async function Ec(e){const t=await wc(e),n=t.eventManager;return n.onListen=Cu.bind(null,t.syncEngine),n.onUnlisten=ku.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=Du.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=Ru.bind(null,t.syncEngine),n}function Sc(e,t,n={}){const r=new T;return e.asyncQueue.enqueueAndForget(async()=>function(e,t,n,r,s){const i=new lc({next:a=>{i.Za(),t.enqueueAndForget(()=>lu(e,o));const u=a.docs.has(n);!u&&a.fromCache?s.reject(new b(_.UNAVAILABLE,"Failed to get document because the client is offline.")):u&&a.fromCache&&r&&"server"===r.source?s.reject(new b(_.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(a)},error:e=>s.reject(e)}),o=new pu(Nn(n.path),i,{includeMetadataChanges:!0,_a:!0});return cu(e,o)}(await Ec(e),e.asyncQueue,t,n,r)),r.promise}function xc(e,t,n={}){const r=new T;return e.asyncQueue.enqueueAndForget(async()=>function(e,t,n,r,s){const i=new lc({next:n=>{i.Za(),t.enqueueAndForget(()=>lu(e,o)),n.fromCache&&"server"===r.source?s.reject(new b(_.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new pu(n,i,{includeMetadataChanges:!0,_a:!0});return cu(e,o)}(await Ec(e),e.asyncQueue,t,n,r)),r.promise}function Cc(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Dc=new Map;function Nc(e,t,n){if(!n)throw new b(_.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Ac(e,t,n,r){if(!0===t&&!0===r)throw new b(_.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function kc(e){if(!G.isDocumentKey(e))throw new b(_.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Rc(e){if(G.isDocumentKey(e))throw new b(_.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Fc(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":w()}function Mc(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new b(_.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Fc(e);throw new b(_.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function Lc(e,t){if(t<=0)throw new b(_.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Vc{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new b(_.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new b(_.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Ac("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Cc(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new b(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new b(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new b(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Pc{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Vc({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new b(_.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new b(_.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Vc(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new S;switch(e.type){case"firstParty":return new N(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new b(_.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Dc.get(e);t&&(m("ComponentProvider","Removing Datastore"),Dc.delete(e),t.terminate())}(this),Promise.resolve()}}function Oc(e,t,n,r={}){var s;const i=(e=Mc(e,Pc))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&p("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=l.MOCK_USER;else{t=o.createMockUserToken(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new b(_.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new l(i)}e._authCredentials=new x(new E(t,n))}}class qc{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new qc(this.firestore,e,this._query)}}class Uc{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Bc(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Uc(this.firestore,e,this._key)}}class Bc extends qc{constructor(e,t,n){super(e,t,Nn(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Uc(this.firestore,null,new G(e))}withConverter(e){return new Bc(this.firestore,e,this._path)}}function zc(e,t,...n){if(e=o.getModularInstance(e),1===arguments.length&&(t=F.newId()),Nc("doc","path",t),e instanceof Pc){const r=U.fromString(t,...n);return kc(r),new Uc(e,null,new G(r))}{if(!(e instanceof Uc||e instanceof Bc))throw new b(_.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(U.fromString(t,...n));return kc(r),new Uc(e.firestore,e instanceof Bc?e.converter:null,new G(r))}}function Gc(e,t){return e=o.getModularInstance(e),t=o.getModularInstance(t),e instanceof qc&&t instanceof qc&&e.firestore===t.firestore&&On(e._query,t._query)&&e.converter===t.converter}class Kc{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new va(this,"async_queue_retry"),this.Vu=()=>{const e=ya();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.t_.jo()},this.mu=e;const t=ya();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;const t=ya();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});const t=new T;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}async pu(){if(0!==this.Pu.length){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!le(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}}gu(e){const t=this.mu.then(()=>(this.du=!0,e().catch(e=>{this.Eu=e,this.du=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw g("INTERNAL UNHANDLED ERROR: ",t),e}).then(e=>(this.du=!1,e))));return this.mu=t,t}enqueueAfterDelay(e,t,n){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);const r=tu.createAndSchedule(this,e,t,n,e=>this.yu(e));return this.Tu.push(r),r}fu(){this.Eu&&w()}verifyOperationInProgress(){}async wu(){let e;do{e=this.mu,await e}while(e!==this.mu)}Su(e){for(const t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{this.Tu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const t of this.Tu)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){const t=this.Tu.indexOf(e);this.Tu.splice(t,1)}}function $c(e){return function(e){if("object"!=typeof e||null===e)return!1;const t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return!0;return!1}(e)}class Qc{constructor(){this._progressObserver={},this._taskCompletionResolver=new T,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class jc extends Pc{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Kc,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new Kc(e),this._firestoreClient=void 0,await e}}}function Wc(e){if(e._terminated)throw new b(_.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||Jc(e),e._firestoreClient}function Jc(e){var t,n,r;const s=e._freezeSettings(),i=function(e,t,n,r){return new wt(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,Cc(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._componentsProvider||(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider}),e._firestoreClient=new mc(e._authCredentials,e._appCheckCredentials,e._queue,i,e._componentsProvider&&function(e){const t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}function Hc(e,t,n){if((e=Mc(e,jc))._firestoreClient||e._terminated)throw new b(_.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new b(_.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},Jc(e)}class Yc{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class Xc{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class Zc{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Zc(lt.fromBase64String(e))}catch(e){throw new b(_.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Zc(lt.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class el{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new b(_.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new z(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class tl{constructor(e){this._methodName=e}}class nl{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new b(_.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new b(_.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return M(this._lat,e._lat)||M(this._long,e._long)}}class rl{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}const sl=/^__.*__$/;class il{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new kr(e,this.data,this.fieldMask,t,this.fieldTransforms):new Ar(e,this.data,t,this.fieldTransforms)}}class ol{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new kr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function al(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw w()}}class ul{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new ul(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.Ou(e),r}Nu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.vu(),r}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return Dl(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(0===e.length)throw this.Bu("Document fields must not be empty");if(al(this.Cu)&&sl.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}}class cl{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||wa(e)}Qu(e,t,n,r=!1){return new ul({Cu:e,methodName:t,qu:n,path:z.emptyPath(),xu:!1,ku:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ll(e){const t=e._freezeSettings(),n=wa(e._databaseId);return new cl(e._databaseId,!!t.ignoreUndefinedProperties,n)}function hl(e,t,n,r,s,i={}){const o=e.Qu(i.merge||i.mergeFields?2:0,t,n,s);El("Data must be an object, but it was:",o,r);const a=bl(r,o);let u,c;if(i.merge)u=new ut(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Sl(t,r,n);if(!o.contains(s))throw new b(_.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Nl(e,s)||e.push(s)}u=new ut(e),c=o.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=o.fieldTransforms;return new il(new $t(a),u,c)}class dl extends tl{_toFieldTransform(e){if(2!==e.Cu)throw 1===e.Cu?e.Bu(`${this._methodName}() can only appear at the top level of your update data`):e.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof dl}}function fl(e,t,n){return new ul({Cu:3,qu:t.settings.qu,methodName:e._methodName,xu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class ml extends tl{_toFieldTransform(e){return new Ir(e.path,new dr)}isEqual(e){return e instanceof ml}}class gl extends tl{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){const t=fl(this,e,!0),n=this.Ku.map(e=>_l(e,t)),r=new fr(n);return new Ir(e.path,r)}isEqual(e){return e instanceof gl&&o.deepEqual(this.Ku,e.Ku)}}class pl extends tl{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){const t=fl(this,e,!0),n=this.Ku.map(e=>_l(e,t)),r=new gr(n);return new Ir(e.path,r)}isEqual(e){return e instanceof pl&&o.deepEqual(this.Ku,e.Ku)}}class yl extends tl{constructor(e,t){super(e),this.$u=t}_toFieldTransform(e){const t=new yr(e.serializer,ar(e.serializer,this.$u));return new Ir(e.path,t)}isEqual(e){return e instanceof yl&&this.$u===e.$u}}function wl(e,t,n,r){const s=e.Qu(1,t,n);El("Data must be an object, but it was:",s,r);const i=[],a=$t.empty();Ze(r,(e,r)=>{const u=Cl(t,e,n);r=o.getModularInstance(r);const c=s.Nu(u);if(r instanceof dl)i.push(u);else{const e=_l(r,c);null!=e&&(i.push(u),a.set(u,e))}});const u=new ut(i);return new ol(a,u,s.fieldTransforms)}function vl(e,t,n,r,s,i){const a=e.Qu(1,t,n),u=[Sl(t,r,n)],c=[s];if(i.length%2!=0)throw new b(_.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)u.push(Sl(t,i[e])),c.push(i[e+1]);const l=[],h=$t.empty();for(let e=u.length-1;e>=0;--e)if(!Nl(l,u[e])){const t=u[e];let n=c[e];n=o.getModularInstance(n);const r=a.Nu(t);if(n instanceof dl)l.push(t);else{const e=_l(n,r);null!=e&&(l.push(t),h.set(t,e))}}const d=new ut(l);return new ol(h,d,a.fieldTransforms)}function Il(e,t,n,r=!1){return _l(n,e.Qu(r?4:3,t))}function _l(e,t){if(Tl(e=o.getModularInstance(e)))return El("Unsupported field value:",t,e),bl(e,t);if(e instanceof tl)return function(e,t){if(!al(t.Cu))throw t.Bu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Bu(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.xu&&4!==t.Cu)throw t.Bu("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=_l(s,t.Lu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=o.getModularInstance(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return ar(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=P.fromDate(e);return{timestampValue:fs(t.serializer,n)}}if(e instanceof P){const n=new P(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:fs(t.serializer,n)}}if(e instanceof nl)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Zc)return{bytesValue:ms(t.serializer,e._byteString)};if(e instanceof Uc){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Bu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ys(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof rl)return function(e,t){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Bu("VectorValues must only contain numeric values.");return ir(t.serializer,e)})}}}}}}(e,t);throw t.Bu(`Unsupported field value: ${Fc(e)}`)}(e,t)}function bl(e,t){const n={};return tt(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Ze(e,(e,r)=>{const s=_l(r,t.Mu(e));null!=s&&(n[e]=s)}),{mapValue:{fields:n}}}function Tl(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof P||e instanceof nl||e instanceof Zc||e instanceof Uc||e instanceof tl||e instanceof rl)}function El(e,t,n){if(!Tl(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Fc(n);throw"an object"===r?t.Bu(e+" a custom object"):t.Bu(e+" "+r)}}function Sl(e,t,n){if((t=o.getModularInstance(t))instanceof el)return t._internalPath;if("string"==typeof t)return Cl(e,t);throw Dl("Field path arguments must be of type string or ",e,!1,void 0,n)}const xl=new RegExp("[~\\*/\\[\\]]");function Cl(e,t,n){if(t.search(xl)>=0)throw Dl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new el(...t.split("."))._internalPath}catch(r){throw Dl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Dl(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new b(_.INVALID_ARGUMENT,a+e+u)}function Nl(e,t){return e.some(e=>e.isEqual(t))}class Al{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Uc(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new kl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Rl("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class kl extends Al{data(){return super.data()}}function Rl(e,t){return"string"==typeof t?Cl(e,t):t instanceof el?t._internalPath:t._delegate._internalPath}function Fl(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new b(_.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Ml{}class Ll extends Ml{}class Vl extends Ll{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Vl(e,t,n)}_apply(e){const t=this._parse(e);return $l(e._query,t),new qc(e.firestore,e.converter,Vn(e._query,t))}_parse(e){const t=ll(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new b(_.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Kl(o,i);const t=[];for(const n of o)t.push(Gl(r,e,n));a={arrayValue:{values:t}}}else a=Gl(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Kl(o,i),a=Il(n,"where",o,"in"===i||"not-in"===i);return en.create(s,i,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}class Pl extends Ml{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Pl(e,t)}_parse(e){const t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:tn.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)$l(n,e),n=Vn(n,e)}(e._query,t),new qc(e.firestore,e.converter,Vn(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Ol extends Ll{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Ol(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new b(_.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new b(_.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Yt(t,n)}(e._query,this._field,this._direction);return new qc(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Cn(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class ql extends Ll{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new ql(e,t,n)}_apply(e){return new qc(e.firestore,e.converter,Pn(e._query,this._limit,this._limitType))}}class Ul extends Ll{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Ul(e,t,n)}_apply(e){const t=zl(e,this.type,this._docOrFields,this._inclusive);return new qc(e.firestore,e.converter,function(e,t){return new Cn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}class Bl extends Ll{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Bl(e,t,n)}_apply(e){const t=zl(e,this.type,this._docOrFields,this._inclusive);return new qc(e.firestore,e.converter,function(e,t){return new Cn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function zl(e,t,n,r){if(n[0]=o.getModularInstance(n[0]),n[0]instanceof Al)return function(e,t,n,r,s){if(!r)throw new b(_.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Rn(e))if(n.field.isKeyField())i.push(kt(t,r.key));else{const e=r.data.field(n.field);if(gt(e))throw new b(_.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new b(_.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Wt(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=ll(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new b(_.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const u=s[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new b(_.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!kn(e)&&-1!==u.indexOf("/"))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=e.path.child(U.fromString(u));if(!G.isDocumentKey(n))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new G(n);a.push(kt(t,s))}else{const e=Il(n,r,u);a.push(e)}}return new Wt(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function Gl(e,t,n){if("string"==typeof(n=o.getModularInstance(n))){if(""===n)throw new b(_.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!kn(t)&&-1!==n.indexOf("/"))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(U.fromString(n));if(!G.isDocumentKey(r))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return kt(e,new G(r))}if(n instanceof Uc)return kt(e,n._key);throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Fc(n)}.`)}function Kl(e,t){if(!Array.isArray(e)||0===e.length)throw new b(_.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function $l(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new b(_.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new b(_.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function Ql(e,t){if(!(t instanceof Vl||t instanceof Pl))throw new b(_.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class jl{convertValue(e,t="none"){switch(bt(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ft(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(mt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw w()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return Ze(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;const s=null===(r=null===(n=null===(t=e.fields)||void 0===t?void 0:t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map(e=>ft(e.doubleValue));return new rl(s)}convertGeoPoint(e){return new nl(ft(e.latitude),ft(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":const n=pt(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(yt(e));default:return null}}convertTimestamp(e){const t=dt(e);return new P(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=U.fromString(e);v(zs(n));const r=new vt(n.get(1),n.get(3)),s=new G(n.popFirst(5));return r.isEqual(t)||g(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Wl(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Jl extends jl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Zc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Uc(this.firestore,null,t)}}function Hl(){return new Yc("count")}class Yl{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Xl extends Al{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Zl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Rl("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Zl extends Xl{data(e={}){return super.data(e)}}class eh{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Yl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new Zl(this._firestore,this._userDataWriter,n.key,n,new Yl(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new b(_.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{const r=new Zl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Yl(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{const r=new Zl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Yl(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:th(t.type),doc:r,oldIndex:s,newIndex:i}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function th(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return w()}}class nh extends jl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Zc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Uc(this.firestore,null,t)}}function rh(e,t){return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){const r=rc(e);try{const e=await function(e,t){const n=I(e),r=P.now(),s=t.reduce((e,t)=>e.add(t.key),nr());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",e=>{let a=jn(),u=nr();return n.cs.getEntries(e,s).next(e=>{a=e,a.forEach((e,t)=>{t.isValidDocument()||(u=u.add(e))})}).next(()=>n.localDocuments.getOverlayedDocuments(e,a)).next(s=>{i=s;const o=[];for(const e of t){const t=Dr(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new kr(e.key,t,Qt(t.value.mapValue),br.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)}).next(t=>{o=t;const r=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)})}).then(()=>({batchId:o.batchId,changes:Hn(i)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Ba[e.currentUser.toKey()];r||(r=new nt(M)),r=r.insert(t,n),e.Ba[e.currentUser.toKey()]=r}(r,e.batchId,n),await $u(r,e.changes),await za(r.remoteStore)}catch(e){const t=nu(e,"Failed to persist write");n.reject(t)}}(await bc(e),t,n)),n.promise}(Wc(e),t)}function sh(e,t,n){const r=n.docs.get(t._key),s=new nh(e);return new Xl(e,s,t._key,r,new Yl(n.hasPendingWrites,n.fromCache),t.converter)}function ih(e,t){const n=Mc(e.firestore,jc),r=Wc(n),s=et(t,(e,t)=>new Ur(t,e.aggregateType,e._internalFieldPath));return function(e,t,n){const r=new T;return e.asyncQueue.enqueueAndForget(async()=>{try{const s=await Tc(e);r.resolve(async function(e,t,n){var r;const s=I(e),{request:i,ut:o,parent:a}=Rs(s.serializer,Mn(t),n);s.connection.Fo||delete i.parent;const u=(await s.Lo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter(e=>!!e.result);v(1===u.length);const c=null===(r=u[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(c).reduce((e,t)=>(e[o[t]]=c[t],e),{})}(s,t,n))}catch(e){r.reject(e)}}),r.promise}(r,e._query,s).then(t=>function(e,t,n){const r=new nh(e);return new Xc(t,r,n)}(n,e,t))}class oh{constructor(e){this.kind="memory",this._onlineComponentProvider=uc.provider,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=sc.provider}toJSON(){return{kind:this.kind}}}class ah{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=dh(void 0),t._initialize(e)),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class uh{constructor(){this.kind="memoryEager",this._offlineComponentProvider=sc.provider}toJSON(){return{kind:this.kind}}}class ch{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new ic(e)}}toJSON(){return{kind:this.kind}}}class lh{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=uc.provider,this._offlineComponentProvider={build:t=>new oc(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}class hh{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=uc.provider,this._offlineComponentProvider={build:t=>new ac(t,null==e?void 0:e.cacheSizeBytes)}}}function dh(e){return new lh(null==e?void 0:e.forceOwnership)}const fh={maxAttempts:5};class mh{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=ll(e)}set(e,t,n){this._verifyNotCommitted();const r=gh(e,this._firestore),s=Wl(r.converter,t,n),i=hl(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,br.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=gh(e,this._firestore);let i;return i="string"==typeof(t=o.getModularInstance(t))||t instanceof el?vl(this._dataReader,"WriteBatch.update",s._key,t,n,r):wl(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,br.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=gh(e,this._firestore);return this._mutations=this._mutations.concat(new Lr(t._key,br.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new b(_.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function gh(e,t){if((e=o.getModularInstance(e)).firestore!==t)throw new b(_.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class ph extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=ll(e)}get(e){const t=gh(e,this._firestore),n=new Jl(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return w();const r=e[0];if(r.isFoundDocument())return new Al(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new Al(this._firestore,n,t._key,null,t.converter);throw w()})}set(e,t,n){const r=gh(e,this._firestore),s=Wl(r.converter,t,n),i=hl(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=gh(e,this._firestore);let i;return i="string"==typeof(t=o.getModularInstance(t))||t instanceof el?vl(this._dataReader,"Transaction.update",s._key,t,n,r):wl(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=gh(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=gh(e,this._firestore),n=new nh(this._firestore);return super.get(e).then(e=>new Xl(this._firestore,n,t._key,e._document,new Yl(!1,!1),t.converter))}}function yh(e,t){if("string"!=typeof e[t])throw new b(_.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class wh{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function vh(e,t){(function(e,t){return e.asyncQueue.enqueue(async()=>function(e,t){I(e).ss.zi=t}(await Ic(e),t))})(Wc(e._firestore),t).then(e=>m(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>p(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}const Ih=new WeakMap;class _h{constructor(){this.Uu=new Map}static get instance(){return bh||(bh=new _h,function(e){if(Qr)throw new Error("a TestingHooksSpi instance is already set");Qr=e}(bh)),bh}et(e){this.Uu.forEach(t=>t(e))}onExistenceFilterMismatch(e){const t=Symbol(),n=this.Uu;return n.set(t,e),()=>n.delete(t)}}let bh=null;!function(e,t=!0){!function(e){h=e}(r.SDK_VERSION),r._registerComponent(new s.Component("firestore",(e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new jc(new C(e.getProvider("auth-internal")),new k(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new b(_.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new vt(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i},"PUBLIC").setMultipleInstances(!0)),r.registerVersion(c,"4.7.3",e),r.registerVersion(c,"4.7.3","cjs2017")}(),t.AbstractUserDataWriter=jl,t.AggregateField=Yc,t.AggregateQuerySnapshot=Xc,t.Bytes=Zc,t.CACHE_SIZE_UNLIMITED=-1,t.CollectionReference=Bc,t.DocumentReference=Uc,t.DocumentSnapshot=Xl,t.FieldPath=el,t.FieldValue=tl,t.Firestore=jc,t.FirestoreError=b,t.GeoPoint=nl,t.LoadBundleTask=Qc,t.PersistentCacheIndexManager=wh,t.Query=qc,t.QueryCompositeFilterConstraint=Pl,t.QueryConstraint=Ll,t.QueryDocumentSnapshot=Zl,t.QueryEndAtConstraint=Bl,t.QueryFieldFilterConstraint=Vl,t.QueryLimitConstraint=ql,t.QueryOrderByConstraint=Ol,t.QuerySnapshot=eh,t.QueryStartAtConstraint=Ul,t.SnapshotMetadata=Yl,t.Timestamp=P,t.Transaction=ph,t.VectorValue=rl,t.WriteBatch=mh,t._AutoId=F,t._ByteString=lt,t._DatabaseId=vt,t._DocumentKey=G,t._EmptyAppCheckTokenProvider=class{getToken(){return Promise.resolve(new A(""))}invalidateToken(){}start(e,t){}shutdown(){}},t._EmptyAuthCredentialsProvider=S,t._FieldPath=z,t._TestingHooks=class{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return _h.instance.onExistenceFilterMismatch(e)}},t._cast=Mc,t._debugAssert=function(e,t){e||w()},t._internalAggregationQueryToProtoRunAggregationQueryRequest=function(e,t){var n;const r=et(t,(e,t)=>new Ur(t,e.aggregateType,e._internalFieldPath)),s=null===(n=Wc(Mc(e.firestore,jc))._onlineComponents)||void 0===n?void 0:n.datastore.serializer;return void 0===s?null:Rs(s,Mn(e._query),r,!0).request},t._internalQueryToProtoQueryTarget=function(e){var t;const n=null===(t=Wc(Mc(e.firestore,jc))._onlineComponents)||void 0===t?void 0:t.datastore.serializer;return void 0===n?null:ks(n,Fn(e._query))._t},t._isBase64Available=function(){return"undefined"!=typeof atob},t._logWarn=p,t._validateIsNotUsedTogether=Ac,t.addDoc=function(e,t){const n=Mc(e.firestore,jc),r=zc(e),s=Wl(e.converter,t);return rh(n,[hl(ll(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,br.exists(!1))]).then(()=>r)},t.aggregateFieldEqual=function(e,t){var n,r;return e instanceof Yc&&t instanceof Yc&&e.aggregateType===t.aggregateType&&(null===(n=e._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=t._internalFieldPath)||void 0===r?void 0:r.canonicalString())},t.aggregateQuerySnapshotEqual=function(e,t){return Gc(e.query,t.query)&&o.deepEqual(e.data(),t.data())},t.and=function(...e){return e.forEach(e=>Ql("and",e)),Pl._create("and",e)},t.arrayRemove=function(...e){return new pl("arrayRemove",e)},t.arrayUnion=function(...e){return new gl("arrayUnion",e)},t.average=function(e){return new Yc("avg",Sl("average",e))},t.clearIndexedDbPersistence=function(e){if(e._initialized&&!e._terminated)throw new b(_.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new T;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!oe.D())return Promise.resolve();const t=e+"main";await oe.delete(t)}(Lo(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise},t.collection=function(e,t,...n){if(e=o.getModularInstance(e),Nc("collection","path",t),e instanceof Pc){const r=U.fromString(t,...n);return Rc(r),new Bc(e,null,r)}{if(!(e instanceof Uc||e instanceof Bc))throw new b(_.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(U.fromString(t,...n));return Rc(r),new Bc(e.firestore,null,r)}},t.collectionGroup=function(e,t){if(e=Mc(e,Pc),Nc("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new b(_.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new qc(e,null,function(e){return new Cn(U.emptyPath(),e)}(t))},t.connectFirestoreEmulator=Oc,t.count=Hl,t.deleteAllPersistentCacheIndexes=function(e){(function(e){return e.asyncQueue.enqueue(async()=>function(e){const t=I(e),n=t.indexManager;return t.persistence.runTransaction("Delete All Indexes","readwrite",e=>n.deleteAllFieldIndexes(e))}(await Ic(e)))})(Wc(e._firestore)).then(e=>m("deleting all persistent cache indexes succeeded")).catch(e=>p("deleting all persistent cache indexes failed",e))},t.deleteDoc=function(e){return rh(Mc(e.firestore,jc),[new Lr(e._key,br.none())])},t.deleteField=function(){return new dl("deleteField")},t.disableNetwork=function(e){return function(e){return e.asyncQueue.enqueue(async()=>{const t=await vc(e),n=await _c(e);return t.setNetworkEnabled(!1),async function(e){const t=I(e);t.L_.add(0),await Ca(t),t.q_.set("Offline")}(n)})}(Wc(e=Mc(e,jc)))},t.disablePersistentCacheIndexAutoCreation=function(e){vh(e,!1)},t.doc=zc,t.documentId=function(){return new el("__name__")},t.enableIndexedDbPersistence=function(e,t){p("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings();return Hc(e,uc.provider,{build:e=>new oc(e,n.cacheSizeBytes,null==t?void 0:t.forceOwnership)}),Promise.resolve()},t.enableMultiTabIndexedDbPersistence=async function(e){p("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=e._freezeSettings();Hc(e,uc.provider,{build:e=>new ac(e,t.cacheSizeBytes)})},t.enableNetwork=function(e){return function(e){return e.asyncQueue.enqueue(async()=>{const t=await vc(e),n=await _c(e);return t.setNetworkEnabled(!0),function(e){const t=I(e);return t.L_.delete(0),xa(t)}(n)})}(Wc(e=Mc(e,jc)))},t.enablePersistentCacheIndexAutoCreation=function(e){vh(e,!0)},t.endAt=function(...e){return Bl._create("endAt",e,!0)},t.endBefore=function(...e){return Bl._create("endBefore",e,!1)},t.ensureFirestoreConfigured=Wc,t.executeWrite=rh,t.getAggregateFromServer=ih,t.getCountFromServer=function(e){return ih(e,{count:Hl()})},t.getDoc=function(e){e=Mc(e,Uc);const t=Mc(e.firestore,jc);return Sc(Wc(t),e._key).then(n=>sh(t,e,n))},t.getDocFromCache=function(e){e=Mc(e,Uc);const t=Mc(e.firestore,jc),n=Wc(t),r=new nh(t);return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await function(e,t){const n=I(e);return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new b(_.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=nu(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Ic(e),t,n)),n.promise}(n,e._key).then(n=>new Xl(t,r,e._key,n,new Yl(null!==n&&n.hasLocalMutations,!0),e.converter))},t.getDocFromServer=function(e){e=Mc(e,Uc);const t=Mc(e.firestore,jc);return Sc(Wc(t),e._key,{source:"server"}).then(n=>sh(t,e,n))},t.getDocs=function(e){e=Mc(e,qc);const t=Mc(e.firestore,jc),n=Wc(t),r=new nh(t);return Fl(e._query),xc(n,e._query).then(n=>new eh(t,r,e,n))},t.getDocsFromCache=function(e){e=Mc(e,qc);const t=Mc(e.firestore,jc),n=Wc(t),r=new nh(t);return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await jo(e,t,!0),s=new Tu(t,r.Ts),i=s.ma(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=nu(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Ic(e),t,n)),n.promise}(n,e._query).then(n=>new eh(t,r,e,n))},t.getDocsFromServer=function(e){e=Mc(e,qc);const t=Mc(e.firestore,jc),n=Wc(t),r=new nh(t);return xc(n,e._query,{source:"server"}).then(n=>new eh(t,r,e,n))},t.getFirestore=function(e,t){const n="object"==typeof e?e:r.getApp(),s="string"==typeof e?e:t||"(default)",i=r._getProvider(n,"firestore").getImmediate({identifier:s});if(!i._initialized){const e=o.getDefaultEmulatorHostnameAndPort("firestore");e&&Oc(i,...e)}return i},t.getPersistentCacheIndexManager=function(e){var t;e=Mc(e,jc);const n=Ih.get(e);if(n)return n;if("persistent"!==(null===(t=Wc(e)._uninitializedComponentsProvider)||void 0===t?void 0:t._offline.kind))return null;const r=new wh(e);return Ih.set(e,r),r},t.increment=function(e){return new yl("increment",e)},t.initializeFirestore=function(e,t,n){n||(n="(default)");const s=r._getProvider(e,"firestore");if(s.isInitialized(n)){const e=s.getImmediate({identifier:n}),r=s.getOptions(n);if(o.deepEqual(r,t))return e;throw new b(_.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new b(_.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new b(_.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return s.initialize({options:t,instanceIdentifier:n})},t.limit=function(e){return Lc("limit",e),ql._create("limit",e,"F")},t.limitToLast=function(e){return Lc("limitToLast",e),ql._create("limitToLast",e,"L")},t.loadBundle=function(e,t){const n=Wc(e=Mc(e,jc)),r=new Qc;return function(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?jr().encode(e):e,function(e,t){return new hc(e,t)}(function(e,t){if(e instanceof Uint8Array)return cc(e,t);if(e instanceof ArrayBuffer)return cc(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,wa(t));e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=I(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=I(e),r=ps(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Gr.getBundleMetadata(e,t.id)).then(e=>!!e&&e.createTime.compareTo(r)>=0)}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Iu(r));const s=new vu(r,e.localStore,t.serializer);let i=await t.Ua();for(;i;){const e=await s.la(i);e&&n._updateProgress(e),i=await t.Ua()}const o=await s.complete();return await $u(e,o.Ia,void 0),await function(e,t){const n=I(e);return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Gr.saveBundleMetadata(e,t))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Pa)}catch(e){return p("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await bc(e),s,r)})}(n,e._databaseId,t,r),r},t.memoryEagerGarbageCollector=function(){return new uh},t.memoryLocalCache=function(e){return new oh(e)},t.memoryLruGarbageCollector=function(e){return new ch(null==e?void 0:e.cacheSizeBytes)},t.namedQuery=function(e,t){return function(e,t){return e.asyncQueue.enqueue(async()=>function(e,t){const n=I(e);return n.persistence.runTransaction("Get named query","readonly",e=>n.Gr.getNamedQuery(e,t))}(await Ic(e),t))}(Wc(e=Mc(e,jc)),t).then(t=>t?new qc(e,null,t.query):null)},t.onSnapshot=function(e,...t){var n,r,s;e=o.getModularInstance(e);let i={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[a]||$c(t[a])||(i=t[a],a++);const u={includeMetadataChanges:i.includeMetadataChanges,source:i.source};if($c(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let c,l,h;if(e instanceof Uc)l=Mc(e.firestore,jc),h=Nn(e._key.path),c={next:n=>{t[a]&&t[a](sh(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=Mc(e,qc);l=Mc(n.firestore,jc),h=n._query;const r=new nh(l);c={next:e=>{t[a]&&t[a](new eh(l,r,n,e))},error:t[a+1],complete:t[a+2]},Fl(e._query)}return function(e,t,n,r){const s=new lc(r),i=new pu(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>cu(await Ec(e),i)),()=>{s.Za(),e.asyncQueue.enqueueAndForget(async()=>lu(await Ec(e),i))}}(Wc(l),h,u,c)},t.onSnapshotsInSync=function(e,t){return function(e,t){const n=new lc(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){I(e).Y_.add(t),t.next()}(await Ec(e),n)),()=>{n.Za(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){I(e).Y_.delete(t)}(await Ec(e),n))}}(Wc(e=Mc(e,jc)),$c(t)?t:{next:t})},t.or=function(...e){return e.forEach(e=>Ql("or",e)),Pl._create("or",e)},t.orderBy=function(e,t="asc"){const n=t,r=Rl("orderBy",e);return Ol._create(r,n)},t.persistentLocalCache=function(e){return new ah(e)},t.persistentMultipleTabManager=function(){return new hh},t.persistentSingleTabManager=dh,t.query=function(e,t,...n){let r=[];t instanceof Ml&&r.push(t),r=r.concat(n),function(e){const t=e.filter(e=>e instanceof Pl).length,n=e.filter(e=>e instanceof Vl).length;if(t>1||t>0&&n>0)throw new b(_.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e},t.queryEqual=Gc,t.refEqual=function(e,t){return e=o.getModularInstance(e),t=o.getModularInstance(t),(e instanceof Uc||e instanceof Bc)&&(t instanceof Uc||t instanceof Bc)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter},t.runTransaction=function(e,t,n){e=Mc(e,jc);const r=Object.assign(Object.assign({},fh),n);return function(e){if(e.maxAttempts<1)throw new b(_.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new T;return e.asyncQueue.enqueueAndForget(async()=>{const s=await Tc(e);new fc(e.asyncQueue,s,n,t,r).au()}),r.promise}(Wc(e),n=>t(new ph(e,n)),r)},t.serverTimestamp=function(){return new ml("serverTimestamp")},t.setDoc=function(e,t,n){e=Mc(e,Uc);const r=Mc(e.firestore,jc),s=Wl(e.converter,t,n);return rh(r,[hl(ll(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,br.none())])},t.setIndexConfiguration=function(e,t){const n=Wc(e=Mc(e,jc));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return p("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function(e){const t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new b(_.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(const e of t.indexes){const t=yh(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(const t of e.fields){const e=Cl("setIndexConfiguration",yh(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new W(e,2)):"ASCENDING"===t.order?r.push(new W(e,0)):"DESCENDING"===t.order&&r.push(new W(e,1))}n.push(new K(K.UNKNOWN_ID,t,r,H.empty()))}return n}(t);return function(e,t){return e.asyncQueue.enqueue(async()=>async function(e,t){const n=I(e),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",e=>r.getFieldIndexes(e).next(n=>function(e,t,n,r,s){e=[...e],t=[...t],e.sort(n),t.sort(n);const i=e.length,o=t.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(e[u],t[a]);i<0?s(e[u++]):i>0?r(t[a++]):(a++,u++)}for(;a<o;)r(t[a++]);for(;u<i;)s(e[u++])}(n,t,j,t=>{s.push(r.addFieldIndex(e,t))},t=>{s.push(r.deleteFieldIndex(e,t))})).next(()=>se.waitFor(s)))}(await Ic(e),t))}(n,r)},t.setLogLevel=function(e){d.setLogLevel(e)},t.snapshotEqual=function(e,t){return e instanceof Xl&&t instanceof Xl?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof eh&&t instanceof eh&&e._firestore===t._firestore&&Gc(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)},t.startAfter=function(...e){return Ul._create("startAfter",e,!1)},t.startAt=function(...e){return Ul._create("startAt",e,!0)},t.sum=function(e){return new Yc("sum",Sl("sum",e))},t.terminate=function(e){return r._removeServiceInstance(e.app,"firestore",e._databaseId.database),e._delete()},t.updateDoc=function(e,t,n,...r){e=Mc(e,Uc);const s=Mc(e.firestore,jc),i=ll(s);let a;return a="string"==typeof(t=o.getModularInstance(t))||t instanceof el?vl(i,"updateDoc",e._key,t,n,r):wl(i,"updateDoc",e._key,t),rh(s,[a.toMutation(e._key,br.exists(!0))])},t.vector=function(e){return new rl(e)},t.waitForPendingWrites=function(e){return function(e){const t=new T;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=I(e);Ma(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=I(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}(n.localStore);if(-1===e)return void t.resolve();const r=n.ka.get(e)||[];r.push(t),n.ka.set(e,r)}catch(e){const n=nu(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await bc(e),t)),t.promise}(Wc(e=Mc(e,jc)))},t.where=function(e,t,n){const r=t,s=Rl("where",e);return Vl._create(s,r,n)},t.writeBatch=function(e){return Wc(e=Mc(e,jc)),new mh(e,t=>rh(e,t))}}}]);